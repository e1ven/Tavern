Structure of Envelopes
=========

A message is the core unit of exchange in Tavern.

{
  "envelope" : {
    "payload" : {
      "author" : {
        "pubkey" : "-----BEGIN PUBLIC KEY-----\nMIIBCgKCAQEAzRc/QIzdhfutaCQuXMyzYxQm7IdzVqLV53Z1EgoetGELcguRjz5p\n9ot6A7dfKaSy+96GmBak+U0dJZvqWzaiV3uTiuI3xMN6D/wK9TegZK69IZKQObG1\npAHduIomZ4cxg22SAzDmnMGqcginA7Niy74LaiCcZY6poJ3g4OGoupuWEOcmGbV9\nx4BnMFuDrmK8t431gTFdKYhijaPmbR2vua54dCUwBMZmytJPZQxOMfb/TCYXsAUf\nEifkBagCpSdGF3qE2qeYPMty8SlHKBQ80L3FpqNYVK+8sXWiF6N2tPDwrOUVYIP+\nFUPJgGcrrWnagiWRwfoklpRinAA/qu5AbQIDAQAB\n-----END PUBLIC KEY-----",
        "friendlyname" : "Anonymous",
        "useragent" : {
          "version" : 0.01,
          "name" : "Tavern Web Frontend"
        }
      },
      "body" : "Welcome to Tavern\r\n=================\r\nTavern is a way to ensure that everyone in the world can\r\ncommunicate freely, without fear of Censorship, Oppression, or corporate manipulation.\r\n\r\nIf you're seeing this note, it's running on a server that runs the Tavern software. \r\nThe primary site for Tavern is [Tavern.com](http://Tavern.com/).\r\n\r\nThis message was posted into the &amp;quot;sitecontent&amp;quot; Topic.\r\n\r\nThis Topic is used as the default for information about the server, such as\r\n\r\n- Frequently Asked Questions\r\n- Formatting Notes\r\n- Terms of Service\r\nAnd the like.\r\n\r\nYou can register a new account either by using the &amp;quot;Register&amp;quot; link, or by replying to an existing comment.\r\n\r\nWe'll be adding more content as time goes on, but I wanted to make sure that there was at least *something* in the default distribution ;)\r\n\r\nThanks, and enjoy the Site!\r\n\r\n-Colin",
      "class" : "message",
      "formatting" : "markdown",
      "subject" : "Welcome to Tavern ;)",
      "topic" : "sitecontent"
    },
    "local" : {
      "sorttopic" : "sitecontent",
      "time_added" : 1354075098.185418,
      "short_subject" : "Welcome-to-Tavern-",
      "formattedbody" : "<h1>Welcome to Tavern</h1>\n<p>Tavern is a way to ensure that everyone in the world can<br />\ncommunicate freely, without fear of Censorship, Oppression, or corporate manipulation.  </p>\n<p>If you're seeing this note, it's running on a server that runs the Tavern software.<br />\nThe primary site for Tavern is <a href=\"http://Tavern.com/\">Tavern.com</a>.  </p>\n<p>This message was posted into the &amp;quot;sitecontent&amp;quot; Topic.  </p>\n<p>This Topic is used as the default for information about the server, such as  </p>\n<ul>\n<li>Frequently Asked Questions  </li>\n<li>Formatting Notes  </li>\n<li>Terms of Service<br />\nAnd the like.  </li>\n</ul>\n<p>You can register a new account either by using the &amp;quot;Register&amp;quot; link, or by replying to an existing comment.  </p>\n<p>We'll be adding more content as time goes on, but I wanted to make sure that there was at least <em>something</em> in the default distribution ;)  </p>\n<p>Thanks, and enjoy the Site!  </p>\n<p>-Colin</p>",
      "attachmentlist" : [

      ],
      "author_pubkey_sha1" : "119279b33e998e0bf6877470ce051f87b1a5e151",
      "embed" : [

      ],
      "calculatedrating" : 1
    },
    "stamps" : [
      {
        "class" : "author",
        "pubkey" : "-----BEGIN PUBLIC KEY-----\nMIIBCgKCAQEAzRc/QIzdhfutaCQuXMyzYxQm7IdzVqLV53Z1EgoetGELcguRjz5p\n9ot6A7dfKaSy+96GmBak+U0dJZvqWzaiV3uTiuI3xMN6D/wK9TegZK69IZKQObG1\npAHduIomZ4cxg22SAzDmnMGqcginA7Niy74LaiCcZY6poJ3g4OGoupuWEOcmGbV9\nx4BnMFuDrmK8t431gTFdKYhijaPmbR2vua54dCUwBMZmytJPZQxOMfb/TCYXsAUf\nEifkBagCpSdGF3qE2qeYPMty8SlHKBQ80L3FpqNYVK+8sXWiF6N2tPDwrOUVYIP+\nFUPJgGcrrWnagiWRwfoklpRinAA/qu5AbQIDAQAB\n-----END PUBLIC KEY-----",
        "signature" : "Kq9kYhckxBdxCC+cOhybMMJsLpCAMGP/BLI14ItRqXaEeQh5CgaPgDNdhwN84TlQRX+Pz/7wVBv5NQ5GXT9Sga4KY2jvbdu5NRpPuvnfvV6dsiqQ5WlYOeCbUSw+xp0sBu07QIRkwwxVNFY45GzkSAnlMq43vE3KEi5H4XxMHBKnU8/y4o66EAix7+T+mfrzjx6bFAhqcELaYl8RfOAY6ZZ484/sq6Z7V0VYMWColKH2eisG0xdul+rPbkgv4mKbtvf4QnBe137G1JQjQRcfQAd8RpdKCx+pLSqIrMsmY5eFtsJCBw2hkfuSlPs7bvUvHEBTKx235rsj2Y50ED5QEw==",
        "time_added" : 1354059443
      },
      {
        "time_added" : 1354059443,
        "hostname" : "Threepwood.local",
        "pubkey" : "-----BEGIN PUBLIC KEY-----\nMIIBCgKCAQEAsIYfIqrCuAaL1aD1IFj4QnbhhDLjdJvnoTzU/1cDSFjn4JcFRf2w\ndP4ZgbNmmx7GCohr61NUUjmadNzJQB5Jvwm6eGXJtXapfwkCPBTLsgGMPhFCOtO+\ny+qMLPCMX/2BhAEWmndmzfjrhkJiCvwW0C25LC6/w9nSDjQkgIZYcFBshw9cKXyi\nRCM1Y01eIzi9DCHp3FupnJI0aoSUTkEosGKPCSkk134689g2sc7fnxpBtNSsSjqB\n93CQ9G8CMMSMWkwykwMgSYv+ZvzFFTr21hiVq6S9Mr6CdQeprCcACGoiYDc4ssDT\nLcA7t8fQgemuMibFkEP9YEoDTI8T/RbIQwIDAQAB\n-----END PUBLIC KEY-----",
        "class" : "server",
        "signature" : "ON9QrBQJo2bDXVEEY7Y0N5cZmCsPtC7iB8nE+EaINdbgGI4RJfLe3RB6S+jiFQG2gCwpY5VJyYdiXTz6HO5Jbow2el7a4FU7Nzjm0ndXP8+CaAKEn0lQE3EkFa7pNc33eiNC+BjW+lBuaxJ8EAjRG5cZKFsehBtX5TQcCMG+ZujBnUigp313j5Uaaf0rPKo5AtUrBuYoHd0lUies1pl2dfH8XK/IbvPrCR+l1qajC3gmC6kCQot25e+rHGAE2BE1GgW0QW8VVvLDdIzRJuktGixXXMuPlOAc0arjKofOLVDyariKyvziD65dVyBj9Ma425AqHEazTPW+ff/NaPsntg=="
      },
      {
        "time_added" : 1354059443,
        "hostname" : "Threepwood.local",
        "pubkey" : "-----BEGIN PUBLIC KEY-----\nMIIBCgKCAQEAsIYfIqrCuAaL1aD1IFj4QnbhhDLjdJvnoTzU/1cDSFjn4JcFRf2w\ndP4ZgbNmmx7GCohr61NUUjmadNzJQB5Jvwm6eGXJtXapfwkCPBTLsgGMPhFCOtO+\ny+qMLPCMX/2BhAEWmndmzfjrhkJiCvwW0C25LC6/w9nSDjQkgIZYcFBshw9cKXyi\nRCM1Y01eIzi9DCHp3FupnJI0aoSUTkEosGKPCSkk134689g2sc7fnxpBtNSsSjqB\n93CQ9G8CMMSMWkwykwMgSYv+ZvzFFTr21hiVq6S9Mr6CdQeprCcACGoiYDc4ssDT\nLcA7t8fQgemuMibFkEP9YEoDTI8T/RbIQwIDAQAB\n-----END PUBLIC KEY-----",
        "class" : "origin",
        "signature" : "ON9QrBQJo2bDXVEEY7Y0N5cZmCsPtC7iB8nE+EaINdbgGI4RJfLe3RB6S+jiFQG2gCwpY5VJyYdiXTz6HO5Jbow2el7a4FU7Nzjm0ndXP8+CaAKEn0lQE3EkFa7pNc33eiNC+BjW+lBuaxJ8EAjRG5cZKFsehBtX5TQcCMG+ZujBnUigp313j5Uaaf0rPKo5AtUrBuYoHd0lUies1pl2dfH8XK/IbvPrCR+l1qajC3gmC6kCQot25e+rHGAE2BE1GgW0QW8VVvLDdIzRJuktGixXXMuPlOAc0arjKofOLVDyariKyvziD65dVyBj9Ma425AqHEazTPW+ff/NaPsntg=="
      },
      {
        "time_added" : 1354075098,
        "hostname" : "gettavern.com",
        "pubkey" : "-----BEGIN PUBLIC KEY-----\nMIIBCgKCAQEArymGitARoguDFDxofHuH6QAhbX91iZJRGgeyfZrXtzCIH5CG+6HX\nLdNdu7dmSkzhVGT2Od32pyw6gievUW5iXnPfHZIU8+jMqYnW1pViRZX316DCv2e8\nWaQlIlY1GYXvI0L5I9IOvyRfOvaFK6L9FdTqT/bChdHcZhaU9uRYsmegFjs53YTW\nLmnQZhrst4jdqRiLFw9b/L9HadeqLIf08zmmE7spxZld34dFDjipKVXYsvhdBpyb\n+l7+za5jh979yJr9Eb4FQC1cf12l9KuohWB2CwW6h/0HwuQ/KM41zdp0NDAyslfH\nVth/aK6sR4I6FLzvniCnredLZ4yaDb03wwIDAQAB\n-----END PUBLIC KEY-----",
        "class" : "server",
        "signature" : "rM0Qu1/sYmKuwdddFmF6vlra/81bVVXWQZPwNfSOdp8JKKGDM0lk/TyL4pvTevK1MIlZUdBropeuaj6XGybtu7iRc5S3RgftWAwn7bAoWSxBadCjJ7T+CtRbvV0hUqb9/HEwQ5MGGUnQSXKY0LErra4kfeTTcNzxnnPxboI9F4J4u6WAOuN8FCPT0Sii8nYCLY1vpwWk9GdmfppGzkIUBrQ+QoSnvaTkUnQ+vGSxDfeALI2tlEMM5c67ohDM8wwtfzWadiJyVcT758Huiqb1f/+0CQtdFPrmYycm8nF/J0/J/WmYHFJ6CHFmuwWNhfE99p0xt7VYFTeG4jCalVNipg=="
      }
    ],
    "payload_sha512" : "f78624b85da662a289699a0b56fda5407a52d869741ebfef5631904ecbddba0c12400b4264be573f0a283841bc6e30c5c4549e4e0e1b72c4c776a570929d1d04"
  }
}
---

Each Tavern Envelope is contained in a JSON dictionary.

TODO- Messages are valid JSON (http://www.ietf.org/rfc/rfc4627.txt?number=4627)
Keys must be ASCII, but values can be Unicode.

The order of fields must be alphabetical - This is to ensure that we can separate them later, but re-assemble them in the same order.
The envelope should be of the most compact JSON.
  In Python this can be generated with -             json.dumps(self.ServerSettings, separators=(',', ':')))
  In PHP, this is generated with -                  $mytext = json_encode($this->dict);
                            $mytext = str_replace('\/','/',$mytext);

The root element of Tavern JSON is the Envelope.
The envelope contains two crucial sections - Payload and Stamps.

  The 'payload' dictionary of an envelope contains all of the UNTOUCHABLE data in an envelope.
  If you modify any data in this section, the envelope is considered a new envelope.
  A SHA-512 hash of the payload section is used as the envelope's ID.. This is stored in the Root Envelope object as 'payload_sha512'

  The payload section contains a dictionary describing the author, as well as metadata about the envelope.
    The 'author' section must contain the author's Public Key 'pubkey', as a PGP formatted key.
      It is suggested that this key does not have version information or comments, in order to reduce size.
    The author section must also have a 'Friendlyname' for the user.
    This is the name that the author prefers is displayed for their post.
      This has to be in every envelope, since we can't rely on being able to pull a profile page.
      Additionally, a user might change this for each post.
      The 'useragent' dictionary MUST contain at least two entries- 'name' and 'version'
        Version should be a number
        Name should be a descriptive string. This should be only the name, - "TavNet", not "Tavnet 4.2/EN-us"
        If you want to store additional information, such as 'language', add an additional field.
        Please note that user-agent is for convienience-only; There is no way to verify that a client is not lying about it's user-agent.
        If this greatly concerns you, I suggest you issue a 'stamp' for the client, rather than relying on the user-agent.

    The payload may have a 'body' field. This should contain the bulk of the message's human-readable text.
      The format for this is up to you (see below), but text or markdown are the most likely to be supported.
    The payload must also have a 'class' field. This will tell us what TYPE of message it is.
      Example classes include 'message', 'rating', and 'privatemessage'.
      The class is used to filter messages, to only see compatible types.
    The Payload may contain a 'formatting' field.
      This will tell the client how to display a message. Examples include 'bbcode', 'markdown', or 'plaintext'
    A payload may have a 'regarding' field.
      This field marks that this envelope is in response to a previous envelope.
      This can either be used as a message reply, or in ratings.
      This is the payload_sha512 of the message it is regarding.
    A payload may have a 'subject' field.
      This field gives the short, 1 sentence summary of what a particular message is about.
      When replying to a message, the subject is often ignored by clients.
      Do NOT add a "re:" field.
      The subject field may not be longer than 200 characters.
    A payload should have a 'topic' field.
      This is used for sorting and categorization. It is the bulk category where a message lives.
      This can be thought of akin to a HashTag in twitter, a Subreddit on Reddit, or a Newsgroup on Usenet.
      There may only ever be ONE topic. This topic must not be longer than 200 characters.
    A payload may contain a binaries section.
      Binaries that are to be included with the message should be uploaded to the server separately, and listed in this section.
      'sha_512' - This is the sha512 of the binary that should be included.
      'filesize_hint' - This is an estimated filesize of the binary. Clients should not trust this number.
      'content_type' - This is the desired content type of the upload.
      'filename' - This is the original filename that the file was uploaded with.
      Keep in mind that the same sha_512 might be uploaded with multiple messages, potentially with differerent filenames or content_types.

  An Envelope should also have an array of Stamps.
    A stamp is a signature of authenticity on a message, asserting something.
    A stamp has at least 4 values-
      'class' - This describes what type of stamp it is.
        Examples include 'author', 'server', or 'origin'
      'pubkey' - This is the public key used by the whatever service stamped the envelope
      'time_added' - This is the time (in unix timestamp) that the server stamped the message.
        This is set by the server, and not verified, so should not be trusted.
      'signature' - This is a PGP signed version of the 'payload_sha512'
        This is used to ensure that the stamp was given to this specific message, not copy/pasted in elsewhere.
      Some types of stamps may have other values, such as 'hostname' in 'server' and 'origin' messages

    Each server that a message travels through may leave a 'server' stamp.
      The origin server will also leave an 'origin' stamp. These are not secure, however.
      Any server a message travels through might remove these stamps, or change the 'origin'

  An envelope may also have a 'local' section.
    This dictionary is server-specific, and should not be transferred along with the message to other servers.
    This is a good place to store when a specific server first received a message, HTML markup, and the like.

The "Body" section should be plaintext, formatted in markdown or bbcode.
  Specify which you are using by with the 'formatting' tag (ex: 'formatting':'markdown' )

