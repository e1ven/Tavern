<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>webtav.webbase &mdash; Tavern  documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Tavern  documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Tavern  documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for webtav.webbase</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">libtavern.user</span>
<span class="kn">import</span> <span class="nn">libtavern.server</span>
<span class="kn">import</span> <span class="nn">libtavern.topic</span>
<span class="kn">import</span> <span class="nn">libtavern.utils</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">tornado.httpserver</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.options</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.escape</span>
<span class="kn">import</span> <span class="nn">tornado.httputil</span>
<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">from</span> <span class="nn">flask.views</span> <span class="kn">import</span> <span class="n">MethodView</span>
<span class="kn">import</span> <span class="nn">webtav.flasknado</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">Server</span><span class="p">()</span>

<div class="viewcode-block" id="XSRFBaseHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.XSRFBaseHandler">[docs]</a><span class="k">class</span> <span class="nc">XSRFBaseHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A version of the Tornado RequestHandler with additional security in the XSRF token.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="XSRFBaseHandler.is_secure"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.XSRFBaseHandler.is_secure">[docs]</a>    <span class="k">def</span> <span class="nf">is_secure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns if the connection is loaded over https&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_secure&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_secure</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s">&#39;https&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_secure</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_secure</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_secure</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="XSRFBaseHandler.xsrf_token"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.XSRFBaseHandler.xsrf_token">[docs]</a>    <span class="k">def</span> <span class="nf">xsrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The XSRF value is a randomly generated string that is set in both POST requests and cookies.</span>

<span class="sd">        Overwritten from the Tornado default to use systemrandom rather than uuid.</span>
<span class="sd">        Like tornado, this method will set a cookie with the xsrf value if it does not currently exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Only generate once/session</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_xsrf_token&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span>
        <span class="c"># Use cookie one if it exists, otherwise random str.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signed_cookie</span><span class="p">(</span><span class="s">&#39;_xsrf&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="c"># Generate a token, save it to a cookie.</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">randstr</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_secure_cookie</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;_xsrf&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">token</span><span class="p">,</span><span class="n">httponly</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">31556952</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span>
</div>
<div class="viewcode-block" id="XSRFBaseHandler.set_secure_cookie"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.XSRFBaseHandler.set_secure_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">set_secure_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c"># Set secure flag when connecting over HTTPS</span>
        <span class="c"># If so, set secure flag on cookie by default.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_secure</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;secure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If the &#39;secure&#39; key exists, even if it&#39;s set to False, the flag will get sent/used.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;secure&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_signed_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XSRFBaseHandler.get_signed_cookie"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.XSRFBaseHandler.get_signed_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">get_signed_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">max_age_days</span><span class="o">=</span><span class="mi">31</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a secure cookie, via Tornado, and returns it as a Unicode string.</span>
<span class="sd">        :param name:The name of the cookie</span>
<span class="sd">        :param value (optional): If passed, get_signed_cookie will get the value from `value` instead of a cookie</span>
<span class="sd">        :return: Unicode string of the cookie</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span><span class="n">max_age_days</span><span class="o">=</span><span class="n">max_age_days</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="XSRFBaseHandler.check_xsrf_cookie"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.XSRFBaseHandler.check_xsrf_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">check_xsrf_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verifies that the ``_xsrf`` cookie matches the ``_xsrf`` argument.</span>

<span class="sd">        To prevent cross-site request forgery, we set an ``_xsrf``</span>
<span class="sd">        cookie and include the same value as a non-cookie</span>
<span class="sd">        field with all ``POST`` requests. If the two do not match, we</span>
<span class="sd">        reject the form submission as a potential forgery.</span>

<span class="sd">        The ``_xsrf`` value may be set as either a form field named ``_xsrf``</span>
<span class="sd">        or in a custom HTTP header named ``X-XSRFToken`` or ``X-CSRFToken``</span>
<span class="sd">        (the latter is accepted for compatibility with Django).</span>

<span class="sd">        See http://en.wikipedia.org/wiki/Cross-site_request_forgery</span>

<span class="sd">        Prior to release 1.1.1, this check was ignored if the HTTP header</span>
<span class="sd">        ``X-Requested-With: XMLHTTPRequest`` was present.  This exception</span>
<span class="sd">        has been shown to be insecure and has been removed.  For more</span>
<span class="sd">        information please see</span>
<span class="sd">        http://www.djangoproject.com/weblog/2011/feb/08/security/</span>
<span class="sd">        http://weblog.rubyonrails.org/2011/2/8/csrf-protection-bypass-in-ruby-on-rails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;_xsrf&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;X-Xsrftoken&quot;</span><span class="p">)</span> <span class="ow">or</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;X-Csrftoken&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;HTTPError&quot;</span><span class="p">,</span><span class="s">&quot;&#39;_xsrf&#39; argument missing from POST&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xsrf_token</span> <span class="o">!=</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;HTTPError&quot;</span><span class="p">,</span><span class="s">&quot;XSRF cookie does not match POST argument&quot;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="BaseTornado"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseTornado">[docs]</a><span class="k">class</span> <span class="nc">BaseTornado</span><span class="p">(</span><span class="n">XSRFBaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default HTTPHandler for webtavern Tornado objects</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the base object for all requests to our Tavern webserver.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Pull a timestamp to use as the canonical time for this request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">gettime</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;timestamp&#39;</span><span class="p">)</span>


        <span class="c"># Before we do anything, see if we have a XSRF cookie set.</span>
        <span class="c"># If not, either set it or abort, depending on the HTTP verb.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signed_cookie</span><span class="p">(</span><span class="s">&#39;_xsrf&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;skipxsrf&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_verbs</span><span class="p">()</span>
            <span class="k">return</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">setheaders</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_session</span><span class="p">()</span>
        <span class="c"># Retrieve the User-Agent if possible.</span>
        <span class="n">ua</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;User-Agent&#39;</span><span class="p">,</span> <span class="s">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">browserdetector</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ua</span><span class="p">)</span>


        <span class="c"># Get the URL for the server if we didn&#39;t set it.</span>
        <span class="c"># We&#39;re pulling this from the request, since we can&#39;t auto-detect our own URL.</span>
        <span class="c"># We don&#39;t re-save serversettings, since we only want it saved if it was intentionally set.</span>
        <span class="c"># TODO: Find some other way of finding this out without checking every request.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;main_url&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;main_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">protocol</span> <span class="o">+</span> <span class="s">&quot;://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">host</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Detected URL as &quot;</span> <span class="o">+</span> <span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;main_url&#39;</span><span class="p">])</span>


        <span class="c"># Check to see if we have support for datauris in our browser.</span>
        <span class="c"># If we do, send the first ~10 pages with datauris.</span>
        <span class="c"># After that switch back, since caching the images is likely to be</span>
        <span class="c"># better, if you&#39;re a recurrent reader</span>
        <span class="c"># If a URL explicltly asks for datauri on or off, disregard prior.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;datauri&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;datauri&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datauri</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;datauri&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;false&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datauri</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">datauri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datauri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">datauri</span>
        <span class="k">elif</span> <span class="n">random</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">()</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">datauri</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datauri</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save_mongo</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span><span class="p">[</span><span class="s">&#39;ua_family&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;IE&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span><span class="p">[</span><span class="s">&#39;ua_versions&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datauri</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datauri</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Do we want to show the original, ignoring edits?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;showoriginal&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">):</span>
            <span class="c"># Convert the string to a bool.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showoriginal</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;showoriginal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;true&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showoriginal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ignore_edits</span>

        <span class="c"># To move forward and backward in the results, we specify a time.</span>
        <span class="c"># We then move this backward/forward, and search with it.</span>
        <span class="c"># This is cheaper than skip() http://docs.mongodb.org/manual/reference/method/cursor.skip/</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">before</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">before</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;after&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">after</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>

        <span class="c"># If people are accessing a URL that isn&#39;t by the canonical URL,</span>
        <span class="c"># redirect them.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;redirected&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>


        <span class="c"># Determine if we should include our location in the post. (default to no)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_location</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">include_location</span> <span class="ow">or</span> <span class="s">&#39;include_location&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span> <span class="o">!=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">include_location</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Set default values for variables we look for.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newmessage</span> <span class="o">=</span> <span class="s">&quot;/newmessage&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Add default JS that is needed everywhere.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_js</span><span class="p">(</span><span class="s">&#39;jquery.min.js&#39;</span><span class="p">)</span>        <span class="c"># Selector Library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_js</span><span class="p">(</span><span class="s">&#39;garlic.min.js&#39;</span><span class="p">)</span>        <span class="c"># Remember user input between refreshes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_js</span><span class="p">(</span><span class="s">&#39;colresizable.min.js&#39;</span><span class="p">)</span>  <span class="c"># Slidable columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_js</span><span class="p">(</span><span class="s">&#39;jquery.unveil.min.js&#39;</span><span class="p">)</span> <span class="c"># LazyLoad Images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_js</span><span class="p">(</span><span class="s">&#39;mousetrap.min.js&#39;</span><span class="p">)</span>     <span class="c"># Keyboard Shortcuts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_js</span><span class="p">(</span><span class="s">&#39;default.min.js&#39;</span><span class="p">)</span>       <span class="c"># Tavern stuff</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useragent</span><span class="p">[</span><span class="s">&#39;ua_family&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;IE&#39;</span> <span class="ow">and</span> <span class="n">browser</span><span class="p">[</span><span class="s">&#39;ua_versions&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_js</span><span class="p">(</span><span class="s">&#39;IE9.js&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BaseTornado.add_js"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseTornado.add_js">[docs]</a>    <span class="k">def</span> <span class="nf">add_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a Javascript file to this request&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">script</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseTornado.load_session"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseTornado.load_session">[docs]</a>    <span class="k">def</span> <span class="nf">load_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">AllowGuestKey</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load into memory the User class by way of the session cookie.</span>

<span class="sd">        Generates a new user (usually guest) if it can&#39;t find one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create a user obj - We&#39;ll either make this into a new user, the default user, or an empty user.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">User</span><span class="p">()</span>

        <span class="c"># Load in our saved passkey if it&#39;s available.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signed_cookie</span><span class="p">(</span><span class="s">&#39;passkey&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">passkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signed_cookie</span><span class="p">(</span><span class="s">&#39;passkey&#39;</span><span class="p">)</span>

        <span class="c"># Load in our session token if we have one.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signed_cookie</span><span class="p">(</span><span class="s">&#39;sessionid&#39;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">load_mongo_by_sessionid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_signed_cookie</span><span class="p">(</span><span class="s">&#39;sessionid&#39;</span><span class="p">))</span>
        <span class="c"># Ensure we have a user that is valid</span>
        <span class="c"># If not, clear cookies, delete user, treat as not-logged-in.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">Keys</span><span class="p">[</span><span class="s">&#39;master&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pubkey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_cookie</span><span class="p">(</span><span class="s">&#39;passkey&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_cookie</span><span class="p">(</span><span class="s">&#39;sessionid&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">User</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ensure_keys</span><span class="p">(</span><span class="n">AllowGuestKey</span><span class="o">=</span><span class="n">AllowGuestKey</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save_mongo</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_session</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseTornado.save_session"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseTornado.save_session">[docs]</a>    <span class="k">def</span> <span class="nf">save_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the current user to a session cookie.</span>
<span class="sd">        These are encrypted by Tornado.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Note - We&#39;re using a sessionid lookup table, not storing a key from the User.</span>
        <span class="c"># This abstraction is useful for 2-factor auth, API lookups, and the like.</span>
        <span class="c"># It does cause a second DB hit, but for now it&#39;s worth the tradeoff.</span>

        <span class="c"># Save our Passkey. This is the key which allows the user to decrypt their keys.</span>
        <span class="c"># This passkey is never stored serverside.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_unique_key</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">passkey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_secure_cookie</span><span class="p">(</span><span class="s">&#39;passkey&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">passkey</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">31556952</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c"># Before we save out the sessionid, make sure the user is valid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ensure_keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save_mongo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_secure_cookie</span><span class="p">(</span><span class="s">&#39;sessionid&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save_session</span><span class="p">(),</span> <span class="n">httponly</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">31556952</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseTornado.setheaders"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseTornado.setheaders">[docs]</a>    <span class="k">def</span> <span class="nf">setheaders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set various headers that each HTTP response should have.&quot;&quot;&quot;</span>
        <span class="c"># Add in a random fortune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;X-Fortune&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">fortune</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;iso-8859-1&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">))</span>

        <span class="c"># Do not allow the content to load in a frame.</span>
        <span class="c"># Should help prevent certain attacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;X-FRAME-OPTIONS&quot;</span><span class="p">,</span> <span class="s">&quot;DENY&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;FRAME-OPTIONS&quot;</span><span class="p">,</span> <span class="s">&quot;DENY&quot;</span><span class="p">)</span>

        <span class="c"># Don&#39;t try to guess content-type.</span>
        <span class="c"># This helps avoid JS sent in an image.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;X-Content-Type-Options&quot;</span><span class="p">,</span> <span class="s">&quot;nosniff&quot;</span><span class="p">)</span>

        <span class="c"># Disable prefetching of content. Since we allow offsite links, this avoids some leakage.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;X-dns-prefetch-control&quot;</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">)</span>

        <span class="c"># IE has additional XSS protection.</span>
        <span class="c"># http://msdn.microsoft.com/en-us/library/dd565647%28v=vs.85%29.aspx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;X-XSS-Protection&quot;</span><span class="p">,</span><span class="s">&quot;1; mode=block;&quot;</span><span class="p">)</span>

        <span class="c"># STS header says to always load over HTTPS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_secure</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;force_sts&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Strict-Transport-Security&quot;</span><span class="p">,</span><span class="s">&quot;max-age=&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;sts_time&#39;</span><span class="p">])</span>


        <span class="c"># http://cspisawesome.com/content_security_policies</span>
        <span class="c"># bottle.response.set_header(</span>
        <span class="c">#     &quot;Content-Security-Policy-Report-Only&quot;,</span>
        <span class="c">#     &quot;default-src &#39;self&#39;; script-src &#39;unsafe-inline&#39; &#39;unsafe-eval&#39; data &#39;self&#39;; object-src &#39;none&#39;; style-src &#39;self&#39;; img-src *; media-src mediaserver; frame-src &quot; +</span>
        <span class="c">#     self.server.serversettings.settings[</span>
        <span class="c">#         &#39;embedserver&#39;] +</span>
        <span class="c">#     &quot; https://www.youtube.com https://player.vimeo.com; font-src &#39;self&#39;; connect-src &#39;self&#39;&quot;)</span>

</div>
<div class="viewcode-block" id="BaseTornado.write_error"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseTornado.write_error">[docs]</a>    <span class="k">def</span> <span class="nf">write_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Catch exceptions and print out an error message using a template.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Return our exception objects to normal objs</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;exc_info&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">exccls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;exc_info&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">exctrc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;exc_info&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="c"># Ensure we have something to print, even if we have to assign it here.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">short</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="s">&#39;Something rather unexpected has happened :/&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">long</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span>  <span class="s">&quot;&quot;&quot;</span>
<span class="s">        It looks like something rather unexpected has happened -</span>
<span class="s">        It&#39;s not clear what went wrong, but clearly something did.</span>
<span class="s">        Dreadfully sorry about that...&quot;&quot;&quot;</span>

        <span class="c"># Try using the value in the exception if possible.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">status_code</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">error_envelope</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s">&#39;Error&#39;</span><span class="p">,</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;topic&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;subject&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-showmessage.html&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseTornado.get_template_path"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseTornado.get_template_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the correct template path for the current theme.</span>

<span class="sd">        Currently this is using the chosen theme, but eventually we can default to mobile/etc here</span>
<span class="sd">        Overwrite to force a handler to use a specific theme (such as SiteMap)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;template_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">theme</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">availablethemes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">basepath</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">theme</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;default&#39;</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">theme</span>

</div>
    <span class="k">def</span> <span class="nf">_rewrite_verbs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replaces all verbs is a handler with safe values in the case where a XSRF token is missing.</span>

<span class="sd">        Note - This does not overwrite the protection against POST request without matching XSRF tokens.</span>
<span class="sd">        That is defined in check_xsrf_cookie()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">retryget</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xsrf_token</span>
            <span class="n">argsdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;skipxsrf&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="n">newurl</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httputil</span><span class="o">.</span><span class="n">url_concat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">argsdict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;!--# include virtual=&quot;&#39;</span> <span class="o">+</span> <span class="n">newurl</span> <span class="o">+</span> <span class="s">&#39;&quot; wait=&quot;yes&quot; --&gt;&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">errorpost</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">weberror</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s">&quot;You&#39;re not supposed to do that ;)&quot;</span><span class="p">,</span><span class="nb">long</span><span class="o">=</span><span class="s">&quot;The URL you that you tried to load requires authentication, but we didn&#39;t receive any. &lt;br&gt; This could be due to a coding error, a network problem such as a proxy server, or someone trying to trick you into clicking a link. &quot;</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">notimplemented</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">405</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;get&#39;</span><span class="p">,</span><span class="n">retryget</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;post&#39;</span><span class="p">,</span><span class="n">errorpost</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;head&#39;</span><span class="p">,</span><span class="n">notimplemented</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;delete&#39;</span><span class="p">,</span><span class="n">notimplemented</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;patch&#39;</span><span class="p">,</span><span class="n">notimplemented</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;put&#39;</span><span class="p">,</span><span class="n">notimplemented</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;options&#39;</span><span class="p">,</span><span class="n">notimplemented</span><span class="p">)</span>

<div class="viewcode-block" id="BaseTornado.get_template_namespace"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseTornado.get_template_namespace">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides a dict of variables/functions that are available to templates.</span>

<span class="sd">        :returns: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
            <span class="n">locale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">,</span>
            <span class="n">_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">translate</span><span class="p">,</span>
            <span class="n">xsrf_form_html</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_form_html</span><span class="p">,</span>
            <span class="n">utils</span><span class="o">=</span><span class="n">libtavern</span><span class="o">.</span><span class="n">utils</span><span class="p">,</span>
            <span class="n">url_for</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">,</span>
            <span class="n">Topic</span><span class="o">=</span><span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">namespace</span>

</div></div>
<div class="viewcode-block" id="BaseFlask"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.BaseFlask">[docs]</a><span class="k">class</span> <span class="nc">BaseFlask</span><span class="p">(</span><span class="n">webtav</span><span class="o">.</span><span class="n">flasknado</span><span class="o">.</span><span class="n">Flasknado</span><span class="p">,</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a basic Flask object which looks and smells very much like a Tornado object.</span>
<span class="sd">    Pass through a copy of our Tornado app.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="weberror"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.weberror">[docs]</a><span class="k">class</span> <span class="nc">weberror</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A generic http error message that supports subject/body.</span>

<span class="sd">    Raising the exception is preferred to calling write_error directly,</span>
<span class="sd">    This way we can log, look up errors in translation, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="nb">long</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="n">short</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long</span> <span class="o">=</span> <span class="nb">long</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Look up the HTTP status code if possible.</span>
        <span class="c"># If not, use the description passed in.</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;HTTP &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httputil</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_message</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span>
</div>
<div class="viewcode-block" id="FlaskHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.FlaskHandler">[docs]</a><span class="k">class</span> <span class="nc">FlaskHandler</span><span class="p">(</span><span class="n">XSRFBaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `RequestHandler` instead calls Flask. This is needed so that we can properly load our own _XSRF records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="FlaskHandler.initialize"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.FlaskHandler.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fallback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span> <span class="o">=</span> <span class="n">fallback</span>
</div>
<div class="viewcode-block" id="FlaskHandler.prepare"><a class="viewcode-back" href="../../webtav.html#webtav.webbase.FlaskHandler.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="bp">True</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Tavern  documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    </div>
  </body>
</html>