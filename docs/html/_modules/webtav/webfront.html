<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>webtav.webfront &mdash; Tavern  documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Tavern  documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Tavern  documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for webtav.webfront</h1><div class="highlight"><pre>
<span class="c"># This file is the Web self.server.</span>
<span class="c"># It defines the routes, and the handlers which create those webpages.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">optparse</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">from</span> <span class="nn">robohash</span> <span class="kn">import</span> <span class="n">Robohash</span>

<span class="kn">import</span> <span class="nn">libtavern.server</span>
<span class="kn">import</span> <span class="nn">libtavern.envelope</span>
<span class="kn">import</span> <span class="nn">libtavern.utils</span>
<span class="kn">import</span> <span class="nn">libtavern.key</span>
<span class="kn">import</span> <span class="nn">libtavern.topic</span>

<span class="kn">import</span> <span class="nn">webtav.webbase</span> <span class="kn">as</span> <span class="nn">webbase</span>
<span class="kn">from</span> <span class="nn">webtav.webbase</span> <span class="kn">import</span> <span class="n">weberror</span>
<span class="kn">import</span> <span class="nn">webtav.uimodules</span>

<span class="kn">import</span> <span class="nn">tornado.httpserver</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.options</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.escape</span>
<span class="kn">import</span> <span class="nn">tornado.wsgi</span>
<span class="kn">import</span> <span class="nn">flask</span>



<div class="viewcode-block" id="EntryHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.EntryHandler">[docs]</a><span class="k">class</span> <span class="nc">EntryHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
<div class="viewcode-block" id="EntryHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.EntryHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A simple redirect, that will redirect people from / to a FAQ.</span>

<span class="sd">        Currently, this redirects everyone.</span>
<span class="sd">        Eventually, it may give a different experience for first-time visitors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/t/sitecontent&#39;</span><span class="p">,</span><span class="n">permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="MessageHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.MessageHandler">[docs]</a><span class="k">class</span> <span class="nc">MessageHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
<div class="viewcode-block" id="MessageHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.MessageHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">topic</span><span class="p">,</span><span class="n">short_sub</span><span class="p">,</span><span class="n">messageid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays a given message.</span>
<span class="sd">        Parameters Topic and Short_sub are ignored - They are in the URL for SEO reasons.</span>
<span class="sd">        :param topic: (not used) - The topic that the message is in.</span>
<span class="sd">        :param short_sub: (not used) - The Short version of the message&#39;s subject.</span>
<span class="sd">        :param messageid: The ID of the message</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">messagesenvelope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="s">&#39;envelopes&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;envelope.local.payload_sha512&#39;</span><span class="p">:</span> <span class="n">messageid</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">messagesenvelope</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">weberror</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s">&quot;Can&#39;t find that message.&quot;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s">&quot;I&#39;m sorry, but we just can&#39;t find the message you&#39;re looking for. ;(&quot;</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="s">&#39;Looking for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">messageid</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">envelope</span><span class="o">.</span><span class="n">Envelope</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">loaddict</span><span class="p">(</span><span class="n">messagesenvelope</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;topic&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">envelope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;subject&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-showmessage.html&#39;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="MessageHistoryHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.MessageHistoryHandler">[docs]</a><span class="k">class</span> <span class="nc">MessageHistoryHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
<div class="viewcode-block" id="MessageHistoryHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.MessageHistoryHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messageid</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">short_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the various edits to a message.&quot;&quot;&quot;</span>

        <span class="n">e</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">envelope</span><span class="o">.</span><span class="n">Envelope</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">loadmongo</span><span class="p">(</span><span class="n">messageid</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">weberror</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s">&quot;That message&#39;s history can&#39;t be found :(&quot;</span><span class="p">,</span>
                                  <span class="nb">long</span><span class="o">=</span><span class="s">&quot;I&#39;m terribly sorry, but I can&#39;t find any history for the message that&#39;s been requested.&quot;</span><span class="p">)</span>

        <span class="c"># Get the original message</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">envelope</span><span class="o">.</span><span class="n">Envelope</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
            <span class="n">original</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">envelope</span><span class="o">.</span><span class="n">Envelope</span><span class="o">.</span><span class="n">MessageRevision</span><span class="p">):</span>
            <span class="n">original</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">get_original</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TavernException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s">&quot;That message&#39;s history can&#39;t be found :(&quot;</span><span class="p">,</span>
                                  <span class="n">body</span><span class="o">=</span><span class="s">&quot;I&#39;m terribly sorry, but I can&#39;t find any history for the message that&#39;s been requested.&quot;</span><span class="p">)</span>

        <span class="c"># Create a list of unique message ids, and the time we first saw it.</span>
        <span class="n">edits</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Append in the original message&#39;s information</span>
        <span class="n">edits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

        <span class="c"># Loop through all the messages we&#39;ve received, add to list.</span>
        <span class="k">if</span> <span class="s">&#39;edits&#39;</span> <span class="ow">in</span> <span class="n">original</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;local&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">editdict</span> <span class="ow">in</span> <span class="n">original</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;local&#39;</span><span class="p">][</span><span class="s">&#39;edits&#39;</span><span class="p">]:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">envelope</span><span class="o">.</span><span class="n">Envelope</span><span class="p">()</span>
                <span class="n">e</span><span class="o">.</span><span class="n">loaddict</span><span class="p">(</span><span class="n">editdict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edits</span><span class="p">:</span>
                    <span class="n">edits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c"># Sort the edits.</span>
        <span class="n">edits</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;local&#39;</span><span class="p">][</span><span class="s">&#39;priority&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;local&#39;</span><span class="p">][</span><span class="s">&#39;time_added&#39;</span><span class="p">])))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">edits</span> <span class="o">=</span> <span class="n">edits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span> <span class="o">=</span> <span class="n">original</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;topic&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">envelope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;History for &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;subject&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-messagehistory.html&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="TopicHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.TopicHandler">[docs]</a><span class="k">class</span> <span class="nc">TopicHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
<div class="viewcode-block" id="TopicHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.TopicHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">topic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the messages for a given topic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">topic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">error_envelope</span><span class="p">(</span>
                <span class="n">subject</span><span class="o">=</span><span class="s">&quot;That topic doesn&#39;t have any messages in it yet!&quot;</span><span class="p">,</span>
                <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="s">&quot;&quot;&quot;The particular topic you&#39;re viewing doesn&#39;t have any posts in it yet.</span>
<span class="s">                You can be the first! Like Neil Armstrong, Edmund Hillary, or Ferdinand Magellan, you have the chance to start something.</span>
<span class="s">                Don&#39;t be nervous. Breathe. You can do this.</span>
<span class="s">                Click the [New Message](&quot;&quot;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/newmessage&#39;</span> <span class="o">+</span><span class="s">&quot;&quot;&quot; &quot;Post Something!&quot;) button, and get started.</span>
<span class="s">                We&#39;re rooting you.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-showmessage.html&#39;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="AllMessagesHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.AllMessagesHandler">[docs]</a><span class="k">class</span> <span class="nc">AllMessagesHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
<div class="viewcode-block" id="AllMessagesHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.AllMessagesHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display all messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;All Messages&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Tavern - All Messages&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specialtopic</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">error_envelope</span><span class="p">(</span>
                <span class="n">subject</span><span class="o">=</span><span class="s">&quot;Welcome to Tavern!&quot;</span><span class="p">,</span>
                <span class="n">topic</span><span class="o">=</span><span class="s">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="s">&quot;&quot;&quot;This Tavern server has __NO__ messages posted yet.</span>
<span class="s">                If it&#39;s public, it should sync up with some other servers soon.</span>
<span class="s">                If not, click the [New Message](&quot;&quot;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/newmessage&#39;</span><span class="o">+</span><span class="s">&quot;&quot;&quot; &quot;Post Something!&quot;) button, and get things started.&quot;&quot;&quot;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-showmessage.html&#39;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="AllSavedHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.AllSavedHandler">[docs]</a><span class="k">class</span> <span class="nc">AllSavedHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
<div class="viewcode-block" id="AllSavedHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.AllSavedHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display all messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Messages from saved topics&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Tavern - Messages in all saved topics&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="s">&quot;/all/saved&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specialtopic</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">topics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">followed_topics</span><span class="p">:</span>
            <span class="n">topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topic</span><span class="o">.</span><span class="n">sortname</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">error_envelope</span><span class="p">(</span>
                <span class="n">subject</span><span class="o">=</span><span class="s">&quot;Welcome to Tavern!&quot;</span><span class="p">,</span>
                <span class="n">topic</span><span class="o">=</span><span class="s">&quot;None&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="s">&quot;&quot;&quot;There are no messages in any topics you have saved.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-showmessage.html&#39;</span><span class="p">)</span>



</div></div>
<div class="viewcode-block" id="ShowAllTopicsHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.ShowAllTopicsHandler">[docs]</a><span class="k">class</span> <span class="nc">ShowAllTopicsHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show every known topic&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ShowAllTopicsHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.ShowAllTopicsHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;List of all topics&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">()</span>
        <span class="n">topics_per_page</span> <span class="o">=</span> <span class="mi">1000</span>

        <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="n">topics_per_page</span> <span class="o">*</span> <span class="n">page</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">alltopics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">toptopics</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">topics_per_page</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
        <span class="n">totalcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;topiclist&#39;</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="n">totalcount</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">alltopics</span><span class="p">)</span> <span class="o">-</span> <span class="n">skip</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-showtopics.html&#39;</span><span class="p">,</span><span class="n">topics</span><span class="o">=</span><span class="n">alltopics</span><span class="p">,</span><span class="n">remaining</span><span class="o">=</span><span class="n">remaining</span><span class="p">,</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="TopicPropertiesHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.TopicPropertiesHandler">[docs]</a><span class="k">class</span> <span class="nc">TopicPropertiesHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show Properties for a topic&quot;&quot;&quot;</span>
<div class="viewcode-block" id="TopicPropertiesHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.TopicPropertiesHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">topic</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Properties for &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">name</span>

        <span class="c"># Get a list of the most popular mods</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;modlist&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;_id.topic&#39;</span><span class="p">:</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">sorttopic</span><span class="p">(</span><span class="n">topic</span><span class="p">)},</span> <span class="n">sortkey</span><span class="o">=</span><span class="s">&#39;value.trust&#39;</span><span class="p">,</span> <span class="n">sortdirection</span><span class="o">=</span><span class="s">&#39;descending&#39;</span><span class="p">):</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-topicprefs.html&#39;</span><span class="p">,</span><span class="n">mods</span><span class="o">=</span><span class="n">mods</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="SiteContentHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.SiteContentHandler">[docs]</a><span class="k">class</span> <span class="nc">SiteContentHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Displays site content, such as FAQ, Ettiquite, etc, without replies or other chrome.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SiteContentHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.SiteContentHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">):</span>
        <span class="n">envelope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
            <span class="s">&#39;envelopes&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;envelope.local.payload_sha512&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">envelope</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">weberror</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s">&quot;That page can&#39;t be found.&quot;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s">&quot;I&#39;m sorry, but the page you&#39;re looking for doesn&#39;t seem to available on this site. ;(&quot;</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="s">&#39;Sitecontent - looking for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">messageid</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">envelope</span><span class="o">.</span><span class="n">Envelope</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">loaddict</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;topic&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">envelope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;subject&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-sitecontent.html&#39;</span><span class="p">)</span>


<span class="c"># def AttachmentHandler_get(attachment):</span>
<span class="c">#     self.getvars()</span>
<span class="c">#     client_attachment_id = tornado.escape.xhtml_escape(attachment)</span>
<span class="c">#     envelopes = self.server.db.unsafe.find(</span>
<span class="c">#         &#39;envelopes&#39;,</span>
<span class="c">#         {&#39;envelope.payload.binaries.sha_512&#39;: client_attachment_id})</span>
<span class="c">#     stack = []</span>
<span class="c">#     for envelope in envelopes:</span>
<span class="c">#         stack.append(envelope)</span>

<span class="c"># Find info from one of the messages</span>
<span class="c">#     for attach in envelope[&#39;envelope&#39;][&#39;local&#39;][&#39;attachmentlist&#39;]:</span>
<span class="c">#         if attach[&#39;sha_512&#39;] == client_attachment_id:</span>
<span class="c">#             myattach = attach</span>

<span class="c"># Determine if we can preview it</span>
<span class="c">#     preview = False</span>
<span class="c">#     if &#39;detected_mime&#39; in myattach:</span>
<span class="c">#         if myattach[&#39;detected_mime&#39;] in [&#39;video/mp4&#39;, &#39;video/webm&#39;, &#39;audio/mpeg&#39;]:</span>
<span class="c">#             preview = True</span>

<span class="c">#     if &#39;displayable&#39; in myattach:</span>
<span class="c">#         if myattach[&#39;displayable&#39;] is not False:</span>
<span class="c">#             preview = True</span>

<span class="c">#     self.write(</span>
<span class="c">#         self.render_string(</span>
<span class="c">#             &#39;header.html&#39;,</span>
<span class="c">#             title=&quot;Tavern Attachment &quot; +</span>
<span class="c">#             client_attachment_id,</span>
<span class="c">#             rsshead=client_attachment_id,</span>
<span class="c">#             type=&quot;attachment&quot;))</span>
<span class="c">#     self.write(self.render_string(</span>
<span class="c">#         &#39;showattachment.html&#39;, myattach=myattach, preview=preview, attachment=client_attachment_id, stack=stack))</span>
<span class="c">#     self.write(self.render_string(&#39;footer.html&#39;))</span>
</div></div>
<div class="viewcode-block" id="RegisterHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.RegisterHandler">[docs]</a><span class="k">class</span> <span class="nc">RegisterHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a new user for the site.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="RegisterHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.RegisterHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Register for a new account&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;topic&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">envelope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayenvelope</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-newuser.html&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RegisterHandler.post"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.RegisterHandler.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getvars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span><span class="s">&#39;header.html&#39;</span><span class="p">,</span>
                   <span class="n">title</span><span class="o">=</span><span class="s">&#39;Register for an account&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rsshead</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>

        <span class="n">client_newuser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">)</span>
        <span class="n">client_newpass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;pass&quot;</span><span class="p">)</span>
        <span class="n">client_newpass2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;pass2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;email&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="n">client_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;email&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">client_email</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">client_email</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client_email</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">client_newpass</span> <span class="o">!=</span> <span class="n">client_newpass2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;I&#39;m sorry, your passwords don&#39;t match.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">client_email</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">users_with_this_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">safe</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,{</span><span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="n">client_email</span><span class="o">.</span><span class="n">lower</span><span class="p">()})</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users_with_this_email</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s">&quot;I&#39;m sorry, this email address has already been used.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">load_mongo_by_username</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">client_newuser</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;I&#39;m sorry, this username has already been taken.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
    <span class="c">#Generate the user</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">AllowGuestKey</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">username</span><span class="o">=</span><span class="n">client_newuser</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">password</span><span class="o">=</span><span class="n">client_newpass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">lastauth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">client_email</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">client_email</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">savemongo</span><span class="p">()</span>

    <span class="c">#Save the passkey out to a separate cookie.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_secure_cookie</span><span class="p">(</span><span class="s">&quot;tavern_passkey&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">Keys</span><span class="p">[</span><span class="s">&#39;master&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_passkey</span><span class="p">(</span>
                <span class="n">client_newpass</span><span class="p">),</span> <span class="n">httponly</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">expires_days</span><span class="o">=</span><span class="mi">999</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">setvars</span><span class="p">()</span>
            <span class="n">bottle</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>


<span class="c"># def LoginHandler_get(slug=None):</span>
<span class="c">#     self.getvars()</span>
<span class="c">#     self.write(self.render_string(&#39;header.html&#39;,</span>
<span class="c">#                title=&quot;Login to your account&quot;, rsshead=None, type=None))</span>
<span class="c">#     self.write(self.render_string(&#39;loginform.html&#39;, slug=slug))</span>
<span class="c">#     self.write(self.render_string(&#39;footer.html&#39;))</span>


<span class="c"># def LoginHandler_post():</span>
<span class="c">#     self.getvars()</span>
<span class="c">#     self.write(self.render_string(&#39;header.html&#39;,</span>
<span class="c">#                title=&#39;Login to your account&#39;, rsshead=None, type=None))</span>

<span class="c">#     successredirect = &#39;/&#39;</span>
<span class="c">#     client_username = self.get_argument(&quot;username&quot;)</span>
<span class="c">#     client_password = self.get_argument(&quot;pass&quot;)</span>
<span class="c">#     if &#39;slug&#39; in self.request.arguments:</span>
<span class="c">#         slug = self.get_argument(&quot;slug&quot;)</span>
<span class="c">#         sluglookup = self.server.db.unsafe.find_one(&#39;redirects&#39;, {&#39;slug&#39;: slug})</span>
<span class="c">#         if sluglookup is not None:</span>
<span class="c">#             if sluglookup[&#39;url&#39;] is not None:</span>
<span class="c">#                 successredirect = sluglookup[&#39;url&#39;]</span>

<span class="c">#     u = User()</span>
<span class="c">#     if u.load_mongo_by_username(username=client_username.lower()):</span>
<span class="c"># The username exists.</span>

<span class="c">#         if u.verify_password(client_password):</span>
<span class="c">#             self.user = u</span>
<span class="c"># You are successfully Authenticated.</span>

<span class="c">#             self.clear_cookie(&#39;tavern_passkey&#39;)</span>
<span class="c">#             self.set_secure_cookie(</span>
<span class="c">#                 &quot;tavern_passkey&quot;,</span>
<span class="c">#                 self.user.Keys[&#39;master&#39;].get_passkey(client_password),</span>
<span class="c">#                 httponly=True,</span>
<span class="c">#                 expires_days=999)</span>
<span class="c">#             self.user.lastauth = int(time.time())</span>

<span class="c">#             self.setvars()</span>
<span class="c">#             self.server.logger.debug(&quot;Login Successful.&quot;)</span>
<span class="c">#             bottle.redirect(successredirect)</span>
<span class="c">#         else:</span>
<span class="c">#             self.server.logger.debug(&quot;Username/password fail.&quot;)</span>
<span class="c"># bottle.redirect(&quot;http://Google.com&quot;)</span>


<span class="c"># def LogoutHandler_post():</span>
<span class="c">#     self.clear_all_cookies()</span>
<span class="c">#     bottle.redirect(&quot;/&quot;)</span>


<span class="c"># def ChangepasswordHandler_get():</span>
<span class="c">#     self.getvars()</span>
<span class="c">#       self.js = &quot;&quot;&quot;{% block extraJS %}</span>
<span class="c">#     &lt;script defer src=&quot;/static/scripts/zxcvbn.min.js?v={{serversettings.settings[&#39;static-revision&#39;]}}&quot;&gt;&lt;/script&gt;</span>
<span class="c">#     &lt;script defer src=&quot;/static/scripts/register.min.js?v={{serversettings.settings[&#39;static-revision&#39;]}}&quot;&gt;&lt;/script&gt;</span>
<span class="c"># {% end extraJS %}&quot;&quot;&quot;</span>
<span class="c">#     if not self.recentauth():</span>
<span class="c">#         numcharacters = 100 + libtavern.TavernUtils.randrange(1, 100)</span>
<span class="c">#         slug = libtavern.TavernUtils.randstr(numcharacters, printable=True)</span>
<span class="c">#         self.server.db.safe.insert(</span>
<span class="c">#             &#39;redirects&#39;,</span>
<span class="c">#             {&#39;slug&#39;: slug,</span>
<span class="c">#              &#39;url&#39;: &#39;/changepassword&#39;,</span>
<span class="c">#              &#39;time&#39;: int(time.time())})</span>
<span class="c">#         bottle.redirect(&#39;/login/&#39; + slug)</span>
<span class="c">#     else:</span>
<span class="c">#         self.write(self.render_string(&#39;header.html&#39;,</span>
<span class="c">#                    title=&quot;Change Password&quot;, rsshead=None, type=None))</span>
<span class="c">#         self.write(self.render_string(&#39;changepassword.html&#39;))</span>
<span class="c">#         self.write(self.render_string(&#39;footer.html&#39;))</span>


<span class="c"># def ChangepasswordHandler_post():</span>
<span class="c">#     self.getvars(AllowGuestKey=False)</span>

<span class="c">#     client_newpass = self.get_argument(&quot;pass&quot;)</span>
<span class="c">#     client_newpass2 = self.get_argument(&quot;pass2&quot;)</span>

<span class="c">#     if client_newpass != client_newpass2:</span>
<span class="c">#         self.write(&quot;I&#39;m sorry, your passwords don&#39;t match.&quot;)</span>
<span class="c">#         return</span>

<span class="c"># Encrypt the the privkey with the new password</span>
<span class="c">#     self.user.changepass(newpassword=client_newpass)</span>

<span class="c"># Set the Passkey, to be able to unlock the Privkey</span>
<span class="c">#     self.set_secure_cookie(&quot;tavern_passkey&quot;, self.user.Keys[&#39;master&#39;].get_passkey(</span>
<span class="c">#         password=client_newpass), httponly=True, expires_days=999)</span>

<span class="c">#     self.setvars()</span>
<span class="c">#     self.server.logger.debug(&quot;Password Change Successful.&quot;)</span>
<span class="c">#     bottle.redirect(&quot;/&quot;)</span>

</div></div>
<div class="viewcode-block" id="UserHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.UserHandler">[docs]</a><span class="k">class</span> <span class="nc">UserHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the User&#39;s information</span>

<span class="sd">    If this is your account, also shows an UI to change settings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="UserHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.UserHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pubkey</span><span class="p">):</span>

        <span class="c"># Generate a new user, using the pubkey we just received.</span>
        <span class="c"># We are careful not to retrieve anything secret.</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">User</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">load_publicinfo_by_pubkey</span><span class="p">(</span><span class="n">pubkey</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
            <span class="s">&#39;View-showuser.html&#39;</span><span class="p">,</span> <span class="n">thatguy</span><span class="o">=</span><span class="n">u</span><span class="p">))</span>


<span class="c"># def ChangeManySettingsHandler_post():</span>
<span class="c">#     self.getvars(AllowGuestKey=False)</span>

<span class="c">#     friendlyname = self.get_argument(&#39;friendlyname&#39;)</span>
<span class="c">#     maxposts = int(self.get_argument(&#39;maxposts&#39;))</span>
<span class="c">#     maxreplies = int(self.get_argument(&#39;maxreplies&#39;))</span>
<span class="c">#     if &#39;include_location&#39; in self.request.arguments:</span>
<span class="c">#         include_location = True</span>
<span class="c">#     else:</span>
<span class="c">#         include_location = False</span>

<span class="c"># AllowEmbed is a int, not a bool, so we can support a 0 state, which</span>
<span class="c"># means, never set.</span>
<span class="c">#     if &#39;allowembed&#39; in self.request.arguments:</span>
<span class="c">#         allowembed = 1</span>
<span class="c">#     else:</span>
<span class="c">#         allowembed = -1</span>
<span class="c">#     if &#39;display_useragent&#39; in self.request.arguments:</span>
<span class="c">#         display_useragent = True</span>
<span class="c">#     else:</span>
<span class="c">#         display_useragent = False</span>

<span class="c">#     if &#39;theme&#39; in self.request.arguments:</span>
<span class="c">#         newtheme = tornado.escape.xhtml_escape(self.get_argument(&#39;theme&#39;))</span>
<span class="c">#         if newtheme in self.server.availablethemes:</span>
<span class="c">#             self.user.theme = newtheme</span>

<span class="c">#     self.user.display_useragent = display_useragent</span>
<span class="c">#     self.user.friendlyname = friendlyname</span>
<span class="c">#     self.user.maxposts = maxposts</span>
<span class="c">#     self.user.maxreplies = maxreplies</span>
<span class="c">#     self.user.include_location = include_location</span>
<span class="c">#     self.user.allow_embed = allowembed</span>

<span class="c">#     self.user.savemongo()</span>
<span class="c">#     self.setvars()</span>

<span class="c">#     if &quot;js&quot; in self.request.arguments:</span>
<span class="c"># self.finish(divs=[&#39;scrollablediv3&#39;])</span>
<span class="c">#         self.finish(divs=[&#39;wrappertable&#39;])</span>

<span class="c">#     else:</span>
<span class="c">#         bottle.redirect(self.server.url_for(user=self.user))</span>


<span class="c"># def ChangeSingleSettingHandler_post(setting, option=None):</span>
<span class="c">#     self.getvars(AllowGuestKey=False)</span>
<span class="c">#     redirect = True</span>
<span class="c">#     if setting == &quot;followtopic&quot;:</span>
<span class="c">#         self.user.follow_topic(</span>
<span class="c">#             self.get_argument(&quot;topic&quot;))</span>
<span class="c">#     elif setting == &quot;unfollowtopic&quot;:</span>
<span class="c">#         self.user.unfollow_topic(</span>
<span class="c">#             self.get_argument(&quot;topic&quot;))</span>
<span class="c">#     elif setting == &quot;showembeds&quot;:</span>
<span class="c">#         self.user.allowembed = 1</span>
<span class="c">#         if option == &#39;ajax&#39;:</span>
<span class="c">#             self.write(&#39;Tavern will now display all external media.&#39;)</span>
<span class="c">#             redirect = False</span>
<span class="c">#     elif setting == &quot;dontshowembeds&quot;:</span>
<span class="c">#         self.user.allowembed = -1</span>
<span class="c">#         self.server.logger.debug(&quot;forbidding embeds&quot;)</span>
<span class="c">#     else:</span>
<span class="c">#         self.server.logger.debug(&quot;Warning, you didn&#39;t do anything!&quot;)</span>

<span class="c">#     self.user.savemongo()</span>
<span class="c">#     self.setvars()</span>
<span class="c">#     if &quot;js&quot; in self.request.arguments:</span>
<span class="c"># self.finish(divs=[&#39;scrollablediv3&#39;])</span>
<span class="c">#         self.finish(divs=[&#39;wrappertable&#39;])</span>

<span class="c">#     else:</span>
<span class="c">#         if redirect:</span>
<span class="c">#             bottle.redirect(&quot;/&quot;)</span>


<span class="c"># def RatingHandler_get(posthash):</span>
<span class="c">#     self.getvars()</span>
<span class="c"># Calculate the votes for that post.</span>


<span class="c"># def RatingHandler_post():</span>
<span class="c">#     self.getvars(AllowGuestKey=False)</span>

<span class="c"># So you may be asking yourself.. Self, why did we do this as a POST, rather than</span>
<span class="c"># Just a GET value, of the form self.server.com/msg123/voteup</span>
<span class="c"># The answer is xsrf protection.</span>
<span class="c"># We don&#39;t want people to link to the upvote button and trick you into</span>
<span class="c"># voting up.</span>

<span class="c">#     client_hash = self.get_argument(&quot;hash&quot;)</span>
<span class="c">#     client_rating = self.get_argument(&quot;rating&quot;)</span>
<span class="c">#     rating_val = int(client_rating)</span>
<span class="c">#     if rating_val not in [-1, 0, 1]:</span>
<span class="c">#         self.write(&quot;Invalid Rating.&quot;)</span>
<span class="c">#         return -1</span>

<span class="c">#     e = libtavern.envelope.Envelope()</span>
<span class="c">#     e.payload.dict[&#39;class&#39;] = &quot;messagerating&quot;</span>
<span class="c">#     e.payload.dict[&#39;rating&#39;] = rating_val</span>
<span class="c">#     e.payload.dict[&#39;regarding&#39;] = client_hash</span>

<span class="c"># Instantiate the user who&#39;s currently logged in</span>

<span class="c">#     e.payload.dict[&#39;author&#39;] = OrderedDict()</span>
<span class="c">#     e.payload.dict[&#39;author&#39;][&#39;replyto&#39;] = self.user.new_posted_key().pubkey</span>
<span class="c">#     e.payload.dict[&#39;author&#39;][</span>
<span class="c">#         &#39;friendlyname&#39;] = self.user.friendlyname</span>

<span class="c">#     if self.user.include_location or &#39;include_location&#39; in self.request.arguments:</span>
<span class="c">#         gi = pygeoip.GeoIP(&#39;datafiles/GeoLiteCity.dat&#39;)</span>
<span class="c">#         ip = self.request.remote_ip</span>

<span class="c"># Don&#39;t check from home.</span>
<span class="c">#         if ip == &quot;127.0.0.1&quot;:</span>
<span class="c">#             ip = &quot;8.8.8.8&quot;</span>

<span class="c">#         gir = gi.record_by_name(ip)</span>
<span class="c">#         e.payload.dict[&#39;coords&#39;] = str(gir[&#39;latitude&#39;]) + \</span>
<span class="c">#             &quot;,&quot; + str(gir[&#39;longitude&#39;])</span>

<span class="c"># Add stamps to show we&#39;re the author (and optionally) we&#39;re the origin</span>
<span class="c"># server</span>
<span class="c">#     e.addStamp(</span>
<span class="c">#         stampclass=&#39;author&#39;,</span>
<span class="c">#         friendlyname=self.user.friendlyname,</span>
<span class="c">#         keys=self.user.Keys[&#39;master&#39;],</span>
<span class="c">#         passkey=self.user.passkey)</span>
<span class="c">#     if self.server.serversettings.settings[&#39;mark-origin&#39;]:</span>
<span class="c">#         e.addStamp(</span>
<span class="c">#             stampclass=&#39;origin&#39;,</span>
<span class="c">#             keys=self.server.ServerKeys,</span>
<span class="c">#             hostname=self.server.serversettings.settings[&#39;hostname&#39;])</span>

<span class="c"># Send to the server</span>
<span class="c">#     self.server.receiveEnvelope(env=e)</span>

<span class="c">#     self.write(&quot;Your vote has been recorded. Thanks!&quot;)</span>


<span class="c"># def UserNoteHandler_get(user):</span>
<span class="c">#     self.getvars()</span>
<span class="c"># Show the Note for a user</span>


<span class="c"># def UserNoteHandler_post():</span>
<span class="c">#     self.getvars(AllowGuestKey=False)</span>

<span class="c">#     client_pubkey = self.get_argument(&quot;pubkey&quot;)</span>
<span class="c">#     client_note = self.get_argument(&quot;note&quot;)</span>
<span class="c">#     self.user.set_note(client_pubkey, client_note)</span>

<span class="c"># Write it back to the page</span>
<span class="c">#     self.write(</span>
<span class="c">#         &#39;&lt;input class=&quot;usernote&quot; type=&quot;text&quot; value=&quot;&quot; name=&quot;note&quot; placeholder=&quot;&#39; +</span>
<span class="c">#         client_note +</span>
<span class="c">#         &#39;&quot;&gt;&#39;)</span>
<span class="c">#     self.server.logger.debug(&quot;Note Submitted.&quot;)</span>


<span class="c"># def UserTrustHandler_get(user):</span>
<span class="c">#     self.getvars()</span>
<span class="c"># Calculate the trust for a user.</span>


<span class="c"># def UserTrustHandler_post():</span>
<span class="c">#     self.getvars(AllowGuestKey=False)</span>

<span class="c">#     trusted_pubkey = urllib.parse.unquote(</span>
<span class="c">#         self.get_argument(&quot;trusted_pubkey&quot;))</span>
<span class="c">#     trusted_pubkey = Key(pub=trusted_pubkey).pubkey</span>

<span class="c">#     client_trust = self.get_argument(&quot;trust&quot;)</span>
<span class="c">#     client_topic = self.get_argument(&quot;topic&quot;)</span>

<span class="c">#     trust_val = int(client_trust)</span>
<span class="c">#     if trust_val not in [-100, 0, 100]:</span>
<span class="c">#         self.write(&quot;Invalid Trust Score.&quot;)</span>
<span class="c">#         return -1</span>

<span class="c">#     e = libtavern.envelope.Envelope()</span>
<span class="c">#     e.payload.dict[&#39;class&#39;] = &quot;usertrust&quot;</span>
<span class="c">#     e.payload.dict[&#39;trust&#39;] = trust_val</span>
<span class="c">#     e.payload.dict[&#39;topic&#39;] = client_topic</span>
<span class="c">#     e.payload.dict[&#39;trusted_pubkey&#39;] = trusted_pubkey</span>

<span class="c"># Instantiate the user who&#39;s currently logged in</span>

<span class="c">#     e.payload.dict[&#39;author&#39;] = OrderedDict()</span>
<span class="c">#     e.payload.dict[&#39;author&#39;][&#39;replyto&#39;] = self.user.new_posted_key().pubkey</span>
<span class="c">#     e.payload.dict[&#39;author&#39;][</span>
<span class="c">#         &#39;friendlyname&#39;] = self.user.friendlyname</span>

<span class="c">#     if self.user.include_location or &#39;include_location&#39; in self.request.arguments:</span>
<span class="c">#         gi = pygeoip.GeoIP(&#39;datafiles/GeoLiteCity.dat&#39;)</span>
<span class="c">#         ip = self.request.remote_ip</span>

<span class="c"># Don&#39;t check from home.</span>
<span class="c">#         if ip == &quot;127.0.0.1&quot;:</span>
<span class="c">#             ip = &quot;8.8.8.8&quot;</span>

<span class="c">#         gir = gi.record_by_name(ip)</span>
<span class="c">#         e.payload.dict[&#39;coords&#39;] = str(gir[&#39;latitude&#39;]) + \</span>
<span class="c">#             &quot;,&quot; + str(gir[&#39;longitude&#39;])</span>

<span class="c"># Add stamps to show we&#39;re the author (and optionally) we&#39;re the origin</span>
<span class="c"># server</span>
<span class="c">#     e.addStamp(</span>
<span class="c">#         stampclass=&#39;author&#39;,</span>
<span class="c">#         friendlyname=self.user.friendlyname,</span>
<span class="c">#         keys=self.user.Keys[&#39;master&#39;],</span>
<span class="c">#         passkey=self.user.passkey)</span>
<span class="c">#     if self.server.serversettings.settings[&#39;mark-origin&#39;]:</span>
<span class="c">#         e.addStamp(</span>
<span class="c">#             stampclass=&#39;origin&#39;,</span>
<span class="c">#             keys=self.server.ServerKeys,</span>
<span class="c">#             hostname=self.server.serversettings.settings[&#39;hostname&#39;])</span>

<span class="c"># Send to the server</span>
<span class="c">#     self.server.receiveEnvelope(env=e)</span>
<span class="c">#     self.server.logger.debug(&quot;Trust Submitted.&quot;)</span>


<span class="c"># def EditMessageHandler_get(regarding):</span>
<span class="c">#     self.getvars()</span>
<span class="c">#     self.write(self.render_string(&#39;header.html&#39;,</span>
<span class="c">#                title=&quot;Edit a message&quot;, rsshead=None, type=None))</span>

<span class="c">#     e = libtavern.envelope.Envelope()</span>
<span class="c">#     e.loadmongo(regarding)</span>
<span class="c">#     oldtext = e.dict[&#39;envelope&#39;][&#39;payload&#39;][&#39;body&#39;]</span>
<span class="c">#     topic = e.dict[&#39;envelope&#39;][&#39;payload&#39;][&#39;topic&#39;]</span>

<span class="c">#     if &#39;edits&#39; in e.dict[&#39;envelope&#39;][&#39;local&#39;]:</span>

<span class="c">#         newestedit = e.dict[&#39;envelope&#39;][&#39;local&#39;][&#39;edits&#39;][-1]</span>
<span class="c">#         e2 = libtavern.envelope.Envelope()</span>
<span class="c">#         e2.loaddict(newestedit)</span>
<span class="c">#         oldtext = e2.dict[&#39;envelope&#39;][&#39;payload&#39;][&#39;body&#39;]</span>
<span class="c">#         topic = e2.dict[&#39;envelope&#39;][&#39;payload&#39;][&#39;topic&#39;]</span>
<span class="c">#         regarding = e2.dict[&#39;envelope&#39;][&#39;payload&#39;][&#39;regarding&#39;]</span>

<span class="c">#     self.write(</span>
<span class="c">#         self.render_string(</span>
<span class="c">#             &#39;editmessageform.html&#39;,</span>
<span class="c">#             oldtext=oldtext,</span>
<span class="c">#             topic=topic, regarding=regarding))</span>
<span class="c">#     self.write(self.render_string(&#39;footer.html&#39;))</span>
<span class="c"># self.finish(divs=[&#39;scrollablediv3&#39;])</span>
<span class="c">#     self.finish(divs=[&#39;wrappertable&#39;])</span>


<span class="c"># def ReplyHandler_get(topic=None, regarding=None):</span>
<span class="c">#     self.getvars()</span>
<span class="c">#     self.write(self.render_string(&#39;header.html&#39;,</span>
<span class="c">#                title=&quot;Reply to a message&quot;, rsshead=None, type=None))</span>
<span class="c">#     self.write(</span>
<span class="c">#         self.render_string(</span>
<span class="c">#             &#39;replyform.html&#39;,</span>
<span class="c">#             regarding=regarding,</span>
<span class="c">#             topic=topic))</span>
<span class="c">#     self.write(self.render_string(&#39;footer.html&#39;))</span>
<span class="c"># self.finish(divs=[&#39;scrollablediv3&#39;])</span>
<span class="c">#     self.finish(divs=[&#39;wrappertable&#39;])</span>
</div></div>
<div class="viewcode-block" id="NewMessageHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.NewMessageHandler">[docs]</a><span class="k">class</span> <span class="nc">NewMessageHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="NewMessageHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.NewMessageHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">topic</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">topic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;New Message for &quot;</span> <span class="o">+</span> <span class="n">topic</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;New Message&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/new&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-newmessage.html&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="NewMessageHandler.options"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.NewMessageHandler.options">[docs]</a>    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">,</span>
                        <span class="s">&#39;OPTIONS, HEAD, GET, POST, PUT, DELETE&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">)</span>


<span class="c"># def NewPrivateMessageHandler_get(urlto=None):</span>
<span class="c">#     self.getvars()</span>
<span class="c">#     self.write(self.render_string(&#39;header.html&#39;,</span>
<span class="c">#                title=&quot;Send a private message&quot;, rsshead=None, type=None))</span>
<span class="c">#     self.write(self.render_string(&#39;privatemessageform.html&#39;, urlto=urlto))</span>
<span class="c">#     self.write(self.render_string(&#39;footer.html&#39;))</span>


<span class="c"># def NullHandler_get(url=None):</span>
<span class="c">#     return</span>


<span class="c"># def NullHandler_post(url=None):</span>
<span class="c">#     return</span>


<span class="c"># def BinariesHandler_get(binaryhash, filename=None):</span>
<span class="c">#     self.server.logger.info(</span>
<span class="c">#         &quot;The gridfs_nginx plugin is a much better option than this method&quot;)</span>
<span class="c">#     self.set_header(&quot;Content-Type&quot;, &#39;application/octet-stream&#39;)</span>

<span class="c">#     req = self.server.bin_GridFS.get_last_version(filename=binaryhash)</span>
<span class="c">#     self.write(req.read())</span>
</div></div>
<div class="viewcode-block" id="CatchallHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.CatchallHandler">[docs]</a><span class="k">class</span> <span class="nc">CatchallHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handler for any requests that aren&#39;t handled anywhere else.</span>
<span class="sd">    Returns 404.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CatchallHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.CatchallHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">weberror</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s">&quot;That page doesn&#39;t exist.&quot;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s">&quot;I&#39;m sorry, but the page you&#39;re looking for can&#39;t be found. ;(&quot;</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span></div>
<div class="viewcode-block" id="CatchallHandler.post"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.CatchallHandler.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">weberror</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s">&quot;That page doesn&#39;t exist.&quot;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s">&quot;I&#39;m sorry, but the page you&#39;re looking for can&#39;t be found. ;(&quot;</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span></div>
<div class="viewcode-block" id="CatchallHandler.put"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.CatchallHandler.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">weberror</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s">&quot;That page doesn&#39;t exist.&quot;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s">&quot;I&#39;m sorry, but the page you&#39;re looking for can&#39;t be found. ;(&quot;</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span></div>
<div class="viewcode-block" id="CatchallHandler.delete"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.CatchallHandler.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">weberror</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="s">&quot;That page doesn&#39;t exist.&quot;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s">&quot;I&#39;m sorry, but the page you&#39;re looking for can&#39;t be found. ;(&quot;</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="AvatarHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.AvatarHandler">[docs]</a><span class="k">class</span> <span class="nc">AvatarHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create Avatars using Robohashes.</span>
<span class="sd">    You should cache these on disk using nginx.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AvatarHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.AvatarHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avatar</span><span class="p">):</span>
        <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;image/&quot;</span> <span class="o">+</span> <span class="n">format</span><span class="p">)</span>

        <span class="c"># Ensure proper sizing</span>
        <span class="n">sizex</span><span class="p">,</span> <span class="n">sizey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;size&#39;</span><span class="p">,</span> <span class="s">&#39;40x40&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">sizex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizex</span><span class="p">)</span>
        <span class="n">sizey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sizex</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="ow">or</span> <span class="n">sizex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sizex</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="k">if</span> <span class="n">sizey</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="ow">or</span> <span class="n">sizey</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sizey</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">robo</span> <span class="o">=</span> <span class="n">Robohash</span><span class="p">(</span><span class="n">avatar</span><span class="p">)</span>
        <span class="n">robo</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span>
            <span class="n">roboset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span>
                <span class="s">&#39;set&#39;</span><span class="p">,</span>
                <span class="s">&#39;any&#39;</span><span class="p">),</span>
            <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">,</span>
            <span class="n">bgset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span>
                <span class="s">&#39;bgset&#39;</span><span class="p">,</span>
                <span class="s">&#39;any&#39;</span><span class="p">),</span>
            <span class="n">sizex</span><span class="o">=</span><span class="n">sizex</span><span class="p">,</span>
            <span class="n">sizey</span><span class="o">=</span><span class="n">sizey</span><span class="p">)</span>
        <span class="n">robo</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>


<span class="c"># def RssHandler(self,action,topic):</span>
<span class="c">#    &quot;&quot;&quot;Generate an RSS feed for a given topic&quot;&quot;&quot;</span>
<span class="c">#     &quot;&quot;&quot;Generates RSS feeds for a Topic.&quot;&quot;&quot;</span>
<span class="c">#     def get(action, topic):</span>
<span class="c">#         channel = rss.Channel(&#39;Tavern - &#39; + param,</span>
<span class="c">#                               &#39;http://GetTavern.com/rss/&#39; + param,</span>
<span class="c">#                               &#39;Tavern discussion about &#39; + param,</span>
<span class="c">#                               generator=&#39;Tavern&#39;,</span>
<span class="c">#                               pubdate=datetime.datetime.utcnow())</span>
<span class="c">#         for envelope in self.server.db.unsafe.find(&#39;envelopes&#39;, {&#39;envelope.local.sorttopic&#39;: libtavern.topic.sorttopic(param), &#39;envelope.payload.class&#39;: &#39;message&#39;}, limit=100, sortkey=&#39;envelope.local.time_added&#39;, sortdirection=&#39;descending&#39;):</span>
<span class="c">#             item = rss.Item(channel,</span>
<span class="c">#                             envelope[&#39;envelope&#39;][&#39;payload&#39;][&#39;subject&#39;],</span>
<span class="c">#                             &quot;http://GetTavern.com/m/&quot; + envelope[</span>
<span class="c">#                                 &#39;envelope&#39;][</span>
<span class="c">#                                 &#39;local&#39;][</span>
<span class="c">#                                 &#39;sorttopic&#39;] + &#39;/&#39; + envelope[</span>
<span class="c">#                                 &#39;envelope&#39;][</span>
<span class="c">#                                 &#39;local&#39;][</span>
<span class="c">#                                 &#39;short_subject&#39;] + &quot;/&quot; + envelope[</span>
<span class="c">#                                 &#39;envelope&#39;][</span>
<span class="c">#                                 &#39;local&#39;][</span>
<span class="c">#                                 &#39;payload_sha512&#39;],</span>
<span class="c">#                             envelope[&#39;envelope&#39;][&#39;local&#39;][&#39;formattedbody&#39;])</span>
<span class="c">#             channel.additem(item)</span>
<span class="c">#         self.write(channel.toprettyxml())</span>

</div></div>
<div class="viewcode-block" id="SiteIndexHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.SiteIndexHandler">[docs]</a><span class="k">class</span> <span class="nc">SiteIndexHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
<div class="viewcode-block" id="SiteIndexHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.SiteIndexHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a sitemap index file, which includes all other sitemap files.</span>
<span class="sd">        Since each sitemap.xml file can only contain 50K urls, we need to split these.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">max_posts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;urls_per_sitemap&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">Topic</span><span class="p">()</span>

        <span class="c"># Without a number, we want the index, which lists the other xml files.</span>
        <span class="c"># - Each one can contain up to 50K URLs</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">include_replies</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">messagecount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">max_posts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c"># Get the base URL for the server</span>
        <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">fqdn</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">+=</span> <span class="s">&quot;sitemap/m/&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-siteindex.html&#39;</span><span class="p">,</span><span class="n">messagecount</span><span class="o">=</span><span class="n">messagecount</span><span class="p">,</span><span class="n">utils</span><span class="o">=</span><span class="n">libtavern</span><span class="o">.</span><span class="n">utils</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SiteIndexHandler.get_template_path"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.SiteIndexHandler.get_template_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Force this request out of the robots folder, since it&#39;s not for people.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;template_path&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">basepath</span> <span class="o">+</span> <span class="s">&#39;/robots&#39;</span>
</div></div>
<div class="viewcode-block" id="SitemapMessagesHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.SitemapMessagesHandler">[docs]</a><span class="k">class</span> <span class="nc">SitemapMessagesHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseTornado</span><span class="p">):</span>
<div class="viewcode-block" id="SitemapMessagesHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.SitemapMessagesHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a sitemap.xml file to show a slice of messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">max_posts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;urls_per_sitemap&#39;</span><span class="p">]</span>

        <span class="c"># We want to figure out how many messages to skip.</span>
        <span class="c"># We do this by multiplying the number of messages per file (max_posts) * which file we&#39;re on.</span>
        <span class="c"># For aesthetic reasons, I think the sitemaps should start at 1, not 0.</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c"># The skip is complicated because we want to avoid using .skip()</span>
        <span class="c"># Instead, every time this function finishes, we store the newest date in it&#39;s slot.</span>
        <span class="c"># Then, we can skip forward to date+1 millisecond for the next slot.</span>


        <span class="c"># Get the highest date for one slot lower than us.</span>
        <span class="n">previous_sitemap</span> <span class="o">=</span> <span class="s">&#39;messages_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="s">&#39;sitemap&#39;</span><span class="p">,{</span><span class="s">&#39;_id&#39;</span><span class="p">:</span><span class="n">previous_sitemap</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;last_message_date&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">after</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">messages</span><span class="p">(</span><span class="n">maxposts</span><span class="o">=</span><span class="n">max_posts</span><span class="p">,</span><span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="p">,</span><span class="n">include_replies</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;That sitemap does not exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># Save our highest value out to the DB</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;messages_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;last_message_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;envelope&#39;</span><span class="p">][</span><span class="s">&#39;local&#39;</span><span class="p">][</span><span class="s">&#39;time_added&#39;</span><span class="p">]</span>
        <span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;sitemap&#39;</span><span class="p">,</span><span class="n">results</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;View-sitemap.html&#39;</span><span class="p">,</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span><span class="n">utils</span><span class="o">=</span><span class="n">libtavern</span><span class="o">.</span><span class="n">utils</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="SitemapMessagesHandler.get_template_path"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.SitemapMessagesHandler.get_template_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Force this request out of the robots folder, since it&#39;s not for people.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;template_path&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">basepath</span> <span class="o">+</span> <span class="s">&#39;/robots&#39;</span>

</div></div>
<div class="viewcode-block" id="XSRFHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.XSRFHandler">[docs]</a><span class="k">class</span> <span class="nc">XSRFHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">XSRFBaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The XSRF handler returns a xsrf token</span>

<span class="sd">    This handler&#39;s output is included into the header via nginx SSI.</span>
<span class="sd">    By importing via SSI, nginx can cache the output from other handlers.</span>

<span class="sd">    Otherwise, each request from a non-logged in user would do a full page-load,</span>
<span class="sd">    since the Set-Cookie would bypass the cache.</span>

<span class="sd">    We do need a separate token for each request, since the site contains a login form.</span>
<span class="sd">    Combining them in nginx lets us have a separate xsrf value while still caching on sessionid.</span>

<span class="sd">    This inherits from XSRFBaseHandler so that it bypasses the regular login/session path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="XSRFHandler.get"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.XSRFHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal only handler that returns the xsrf token.</span>
<span class="sd">        This is called by nginx, not accessible to the outside world.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_token</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="XSRFHandler.get_template_path"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.XSRFHandler.get_template_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Force this request out of the robots folder, since it&#39;s not for people.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;template_path&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">basepath</span> <span class="o">+</span> <span class="s">&#39;/robots&#39;</span>
</div></div>
<div class="viewcode-block" id="UploadHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.UploadHandler">[docs]</a><span class="k">class</span> <span class="nc">UploadHandler</span><span class="p">(</span><span class="n">webbase</span><span class="o">.</span><span class="n">BaseFlask</span><span class="p">):</span>

<div class="viewcode-block" id="UploadHandler.receive_files"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.UploadHandler.receive_files">[docs]</a>    <span class="k">def</span> <span class="nf">receive_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive files, save them out.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Each file in self.request.files is a Werkzeug FileStorage object.</span>
        <span class="c"># http://werkzeug.pocoo.org/docs/datastructures/#werkzeug.datastructures.FileStorage</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span><span class="nb">file</span><span class="o">.</span><span class="n">filesize</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hash_file</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">filesize</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;uploads&#39;</span><span class="p">][</span><span class="s">&#39;max_size&#39;</span><span class="p">]:</span>
                <span class="nb">list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">=</span> <span class="n">magic</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">memcopy</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">mime</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="c"># Make a preview image if possible</span>
            <span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">filesize</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;uploads&#39;</span><span class="p">][</span><span class="s">&#39;max_image_size&#39;</span><span class="p">]:</span>
                <span class="n">memcopy</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">memcopy</span><span class="p">)</span>
                <span class="n">memcopy</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">mimetype</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;image/gif&#39;</span><span class="p">,</span> <span class="s">&#39;image/jpeg&#39;</span><span class="p">,</span> <span class="s">&#39;image/png&#39;</span><span class="p">,</span> <span class="s">&#39;image/bmp&#39;</span><span class="p">]:</span>
                    <span class="c"># Our attachment appears to be an image -</span>
                    <span class="c"># If we open and resave, it will strip the EXIF data.</span>
                    <span class="n">memcopy</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">memcopy</span><span class="p">)</span>
                    <span class="n">Image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">memcopy</span><span class="p">)</span>

                    <span class="c"># Don&#39;t generate a preview/etc here.</span>
                    <span class="c"># We need to do that as a sub-function of receiveEnvelope, so it happens for ALL envelopes.</span>
                    <span class="nb">file</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">memcopy</span>
            <span class="c"># Save the file out to GridFS</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">bin_GridFS</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="nb">file</span><span class="o">.</span><span class="n">sha</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">bin_GridFS</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="nb">file</span><span class="o">.</span><span class="n">sha</span><span class="p">,</span><span class="n">content_type</span><span class="o">=</span><span class="nb">file</span><span class="o">.</span><span class="n">mimetype</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="UploadHandler.post"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.UploadHandler.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Receive Envelopes and their attachments.&quot;&quot;&quot;</span>

        <span class="c"># If there are any files that were sent along with the envelope, save them out.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receive_files</span><span class="p">()</span>

        <span class="c"># Send a JSON formatted reply to the JS upload-handler if necessary.</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&quot;fileonly&quot;</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                <span class="n">detail</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">detail</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attached_file</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
                <span class="n">detail</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attached_file</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">]</span>
                <span class="n">detail</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attached_file</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span>
                <span class="n">detail</span><span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attached_file</span><span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">]</span>
                <span class="n">detail</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;downloads_url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attached_file</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">]</span>
                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
            <span class="n">details_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">details_json</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># Add the binaries which are only referenced, not multipart posted.</span>
        <span class="c"># This is not unusual - The jQuery uploaded will upload them separately, for example.</span>

        <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">argument</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;referenced_file&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">argument</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_name&#39;</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;referenced_file(.*?)_name&#39;</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
                <span class="n">binarycount</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mybinary</span> <span class="o">=</span> <span class="n">Envelope</span><span class="o">.</span><span class="n">binary</span><span class="p">(</span><span class="n">sha512</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span>
                    <span class="s">&#39;referenced_file&#39;</span> <span class="o">+</span> <span class="n">binarycount</span> <span class="o">+</span> <span class="s">&#39;_hash&#39;</span><span class="p">))</span>
                <span class="n">mybinary</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;filesize_hint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span>
                    <span class="s">&#39;referenced_file&#39;</span> <span class="o">+</span> <span class="n">binarycount</span> <span class="o">+</span> <span class="s">&#39;_size&#39;</span><span class="p">)</span>
                <span class="n">mybinary</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span>
                    <span class="s">&#39;referenced_file&#39;</span> <span class="o">+</span> <span class="n">binarycount</span> <span class="o">+</span> <span class="s">&#39;_contenttype&#39;</span><span class="p">)</span>
                <span class="n">mybinary</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span>
                    <span class="s">&#39;referenced_file&#39;</span> <span class="o">+</span> <span class="n">binarycount</span> <span class="o">+</span> <span class="s">&#39;_name&#39;</span><span class="p">)</span>
                <span class="n">envelopebinarylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mybinary</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>



        <span class="c"># Now that we have the file handled.. (Whew!) .. Let&#39;s do the Envelope</span>
        <span class="c"># Pull in our Form variables.</span>
        <span class="n">client_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;body&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">client_topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">client_subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;subject&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">client_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">client_regarding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;regarding&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">e</span> <span class="o">=</span> <span class="n">Envelope</span><span class="p">()</span>
        <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;formatting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;markdown&quot;</span>

        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;message&#39;</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;message&quot;</span>
            <span class="k">if</span> <span class="n">client_topic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;topic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_topic</span>
            <span class="k">if</span> <span class="n">client_subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_subject</span>
            <span class="k">if</span> <span class="n">client_body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_body</span>

            <span class="k">if</span> <span class="n">envelopebinarylist</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;binaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">envelopebinarylist</span>

            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span>
                <span class="s">&#39;author&#39;</span><span class="p">][</span>
                <span class="s">&#39;replyto&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">Keys</span><span class="p">[</span>
                <span class="s">&#39;posted&#39;</span><span class="p">][</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pubkey</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">][</span>
                <span class="s">&#39;friendlyname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;friendlyname&#39;</span><span class="p">]</span>

            <span class="n">e</span><span class="o">.</span><span class="n">addStamp</span><span class="p">(</span>
                <span class="n">stampclass</span><span class="o">=</span><span class="s">&#39;author&#39;</span><span class="p">,</span>
                <span class="n">friendlyname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;friendlyname&#39;</span><span class="p">],</span>
                <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">Keys</span><span class="p">[</span><span class="s">&#39;master&#39;</span><span class="p">],</span>
                <span class="n">passkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">passkey</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;reply&#39;</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;message&quot;</span>
            <span class="k">if</span> <span class="n">client_regarding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;regarding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_regarding</span>
                <span class="n">regardingmsg</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
                    <span class="s">&#39;envelopes&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s">&#39;envelope.local.payload_sha512&#39;</span><span class="p">:</span> <span class="n">client_regarding</span><span class="p">})</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;topic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regardingmsg</span><span class="p">[</span>
                    <span class="s">&#39;envelope&#39;</span><span class="p">][</span>
                    <span class="s">&#39;payload&#39;</span><span class="p">][</span>
                    <span class="s">&#39;topic&#39;</span><span class="p">]</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regardingmsg</span><span class="p">[</span>
                    <span class="s">&#39;envelope&#39;</span><span class="p">][</span>
                    <span class="s">&#39;payload&#39;</span><span class="p">][</span>
                    <span class="s">&#39;subject&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">client_body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_body</span>
            <span class="k">if</span> <span class="n">envelopebinarylist</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;binaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">envelopebinarylist</span>

            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">][</span><span class="s">&#39;replyto&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">Keys</span><span class="p">[</span><span class="s">&#39;posted&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pubkey</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">][</span>
                <span class="s">&#39;friendlyname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;friendlyname&#39;</span><span class="p">]</span>

            <span class="n">e</span><span class="o">.</span><span class="n">addStamp</span><span class="p">(</span>
                <span class="n">stampclass</span><span class="o">=</span><span class="s">&#39;author&#39;</span><span class="p">,</span>
                <span class="n">friendlyname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;friendlyname&#39;</span><span class="p">],</span>
                <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">Keys</span><span class="p">[</span><span class="s">&#39;master&#39;</span><span class="p">],</span>
                <span class="n">passkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">passkey</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;messagerevision&#39;</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;messagerevision&quot;</span>
            <span class="k">if</span> <span class="n">client_body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_body</span>
            <span class="k">if</span> <span class="n">client_regarding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;regarding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_regarding</span>
                <span class="n">regardingmsg</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
                    <span class="s">&#39;envelopes&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s">&#39;envelope.local.payload_sha512&#39;</span><span class="p">:</span> <span class="n">client_regarding</span><span class="p">})</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;topic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regardingmsg</span><span class="p">[</span>
                    <span class="s">&#39;envelope&#39;</span><span class="p">][</span>
                    <span class="s">&#39;payload&#39;</span><span class="p">][</span>
                    <span class="s">&#39;topic&#39;</span><span class="p">]</span>
                <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regardingmsg</span><span class="p">[</span>
                    <span class="s">&#39;envelope&#39;</span><span class="p">][</span>
                    <span class="s">&#39;payload&#39;</span><span class="p">][</span>
                    <span class="s">&#39;subject&#39;</span><span class="p">]</span>
            <span class="n">e</span><span class="o">.</span><span class="n">addStamp</span><span class="p">(</span>
                <span class="n">stampclass</span><span class="o">=</span><span class="s">&#39;author&#39;</span><span class="p">,</span>
                <span class="n">friendlyname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;friendlyname&#39;</span><span class="p">],</span>
                <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">Keys</span><span class="p">[</span><span class="s">&#39;master&#39;</span><span class="p">],</span>
                <span class="n">passkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">passkey</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="s">&#39;privatemessage&#39;</span><span class="p">:</span>
            <span class="c"># For encrypted messages we want to actually create a whole</span>
            <span class="c"># sub-envelope inside of it!</span>

            <span class="n">single_use_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_pmkey</span><span class="p">()</span>
            <span class="n">single_use_key</span><span class="o">.</span><span class="n">unlock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">passkey</span><span class="p">)</span>

            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;privatemessage&quot;</span>
            <span class="n">touser</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">pub</span><span class="o">=</span><span class="n">client_to</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">touser</span><span class="o">.</span><span class="n">pubkey</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">][</span><span class="s">&#39;replyto&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_use_key</span><span class="o">.</span><span class="n">pubkey</span>

            <span class="n">encrypted_msg</span> <span class="o">=</span> <span class="n">Envelope</span><span class="p">()</span>
            <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;formatting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;markdown&quot;</span>
            <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_body</span>
            <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;privatemessage&#39;</span>

            <span class="k">if</span> <span class="n">client_regarding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">encrypted</span><span class="p">[</span><span class="s">&#39;regarding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_regarding</span>
                <span class="n">regardingmsg</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
                    <span class="s">&#39;envelopes&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s">&#39;envelope.local.payload_sha512&#39;</span><span class="p">:</span> <span class="n">client_regarding</span><span class="p">})</span>

                <span class="c"># The message we&#39;re referencing is likey unreadable due to encryption.</span>
                <span class="c"># Pull in it&#39;s subject if possible.</span>
                <span class="n">decrypted_regarding_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
                    <span class="n">regardingmsg</span><span class="p">[</span><span class="s">&#39;payload&#39;</span><span class="p">][</span><span class="s">&#39;encrypted&#39;</span><span class="p">])</span>
                <span class="n">decrypted_regarding</span> <span class="o">=</span> <span class="n">Envelope</span><span class="p">()</span>
                <span class="n">decrypted_regarding</span><span class="o">.</span><span class="n">loaddict</span><span class="p">(</span><span class="n">decrypted_regarding_dict</span><span class="p">)</span>

                <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span>
                    <span class="s">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decrypted_regarding</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span>
                    <span class="s">&#39;subject&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_subject</span>

            <span class="k">if</span> <span class="n">envelopebinarylist</span><span class="p">:</span>
                <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;binaries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">envelopebinarylist</span>

            <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span>
                <span class="s">&#39;author&#39;</span><span class="p">][</span>
                <span class="s">&#39;replyto&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_use_key</span><span class="o">.</span><span class="n">pubkey</span>
            <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">][</span>
                <span class="s">&#39;friendlyname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;friendlyname&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;include_location&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;include_location&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
                <span class="n">gi</span> <span class="o">=</span> <span class="n">pygeoip</span><span class="o">.</span><span class="n">GeoIP</span><span class="p">(</span><span class="s">&#39;data/GeoLiteCity.dat&#39;</span><span class="p">)</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>

                <span class="c"># Don&#39;t check from home.</span>
                <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">:</span>
                    <span class="n">ip</span> <span class="o">=</span> <span class="s">&quot;8.8.8.8&quot;</span>

                <span class="n">gir</span> <span class="o">=</span> <span class="n">gi</span><span class="o">.</span><span class="n">record_by_name</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
                <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gir</span><span class="p">[</span><span class="s">&#39;latitude&#39;</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gir</span><span class="p">[</span><span class="s">&#39;longitude&#39;</span><span class="p">])</span>

            <span class="c"># Add stamps to show we&#39;re the author (and optionally) we&#39;re the</span>
            <span class="c"># origin server</span>
            <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">addStamp</span><span class="p">(</span>
                <span class="n">stampclass</span><span class="o">=</span><span class="s">&#39;author&#39;</span><span class="p">,</span>
                <span class="n">friendlyname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;friendlyname&#39;</span><span class="p">],</span>
                <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">Keys</span><span class="p">[</span><span class="s">&#39;master&#39;</span><span class="p">],</span>
                <span class="n">passkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">passkey</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;mark-origin&#39;</span><span class="p">]:</span>
                    <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">addStamp</span><span class="p">(</span>
                        <span class="n">stampclass</span><span class="o">=</span><span class="s">&#39;origin&#39;</span><span class="p">,</span>
                        <span class="n">keys</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">ServerKeys</span><span class="p">,</span>
                        <span class="n">hostname</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;hostname&#39;</span><span class="p">])</span>

            <span class="c"># Now that we&#39;ve created the inner message, convert it to text,</span>
            <span class="c"># store it in the outer message.</span>
            <span class="n">encrypted_pmstr</span> <span class="o">=</span> <span class="n">encrypted_msg</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;encrypted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_use_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
                <span class="n">encrypt_to</span><span class="o">=</span><span class="n">touser</span><span class="o">.</span><span class="n">pubkey</span><span class="p">,</span>
                <span class="n">encryptstring</span><span class="o">=</span><span class="n">encrypted_pmstr</span><span class="p">)</span>

        <span class="c"># For all classses of messages-</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">UserSettings</span><span class="p">[</span><span class="s">&#39;include_location&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;include_location&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="n">gi</span> <span class="o">=</span> <span class="n">pygeoip</span><span class="o">.</span><span class="n">GeoIP</span><span class="p">(</span><span class="s">&#39;data/GeoLiteCity.dat&#39;</span><span class="p">)</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>

            <span class="c"># Don&#39;t check from home.</span>
            <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="s">&quot;8.8.8.8&quot;</span>

            <span class="n">gir</span> <span class="o">=</span> <span class="n">gi</span><span class="o">.</span><span class="n">record_by_name</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gir</span><span class="p">[</span><span class="s">&#39;latitude&#39;</span><span class="p">])</span> <span class="o">+</span> \
                <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gir</span><span class="p">[</span><span class="s">&#39;longitude&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;mark-origin&#39;</span><span class="p">]:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">addStamp</span><span class="p">(</span>
                    <span class="n">stampclass</span><span class="o">=</span><span class="s">&#39;origin&#39;</span><span class="p">,</span>
                    <span class="n">keys</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">ServerKeys</span><span class="p">,</span>
                    <span class="n">hostname</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;hostname&#39;</span><span class="p">])</span>

        <span class="c"># Send to the server</span>
        <span class="n">newmsgid</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">receiveEnvelope</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newmsgid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_to</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">client_regarding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/message/&#39;</span> <span class="o">+</span> <span class="n">server</span><span class="o">.</span><span class="n">getTopMessage</span><span class="p">(</span>
                        <span class="n">newmsgid</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;?jumpto=&quot;</span> <span class="o">+</span> <span class="n">newmsgid</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/message/&#39;</span> <span class="o">+</span> <span class="n">newmsgid</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/showprivates&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Failure to insert message.&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="FileOnlyUploadHandler"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.FileOnlyUploadHandler">[docs]</a><span class="k">class</span> <span class="nc">FileOnlyUploadHandler</span><span class="p">(</span><span class="n">UploadHandler</span><span class="p">):</span>
<div class="viewcode-block" id="FileOnlyUploadHandler.post"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.FileOnlyUploadHandler.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Receive a POST request containing a file from JS, and return the JSON formatted reply it&#39;s expecting.&quot;&quot;&quot;</span>

        <span class="c"># If there are any files that were sent along with the envelope, save them out.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receive_files</span><span class="p">()</span>

        <span class="c"># Send a JSON formatted reply to the JS upload-handler if necessary.</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">detail</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">name</span>
            <span class="n">detail</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">sha</span>
            <span class="n">detail</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">filesize</span>
            <span class="n">detail</span><span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">mimetype</span>
            <span class="n">detail</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;downloads_url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">file</span><span class="o">.</span><span class="n">sha</span>
            <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
        <span class="n">details_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">details_json</span><span class="p">)</span>
        <span class="k">return</span>
</div></div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../webtav.html#webtav.webfront.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts and runs the Python component of the Tavern web interface.</span>
<span class="sd">    You are NOT supposed to connect to Tornado directly, connections MUST go through Nginx.</span>
<span class="sd">    Nginx will connect to tornado through a domain socket.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Define our App</span>
    <span class="c"># Set up Command Line Parsing</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">add_help_option</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;The Tavern web interface&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="s">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;Set loglevel. Use more than once to log extra stuff (3 max)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-s&quot;</span><span class="p">,</span> <span class="s">&quot;--socket&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;socket&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;Location of Unix Domain Socket to listen on&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-?&quot;</span><span class="p">,</span> <span class="s">&quot;--help&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;help&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;Show this helpful message.&quot;</span><span class="p">)</span>

    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">socket</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Requires Unix Socket file destination :/ &quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


    <span class="c"># Create the Tavern server. This is the main interop class for dealing with Tavern.</span>
    <span class="c"># We then start the server, which creates DB connections, fires up threads to create keys, etc.</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">libtavern</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">Server</span><span class="p">()</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c"># Specify the settings which are not designed to be overwritten.</span>
    <span class="n">tornado_settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;template_path&quot;</span><span class="p">:</span> <span class="s">&quot;webtav/themes&quot;</span><span class="p">,</span>
        <span class="s">&quot;autoescape&quot;</span><span class="p">:</span> <span class="s">&quot;xhtml_escape&quot;</span><span class="p">,</span>
        <span class="s">&quot;ui_modules&quot;</span><span class="p">:</span> <span class="n">webtav</span><span class="o">.</span><span class="n">uimodules</span><span class="p">,</span>
        <span class="s">&quot;xsrf_cookies&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="c"># SSI requires that gzip is disabled in Tornado.</span>
        <span class="s">&quot;gzip&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;cookie_secret&quot;</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">flask_settings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># Update the settings dicts for both engines</span>
    <span class="n">tornado_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;tornado&#39;</span><span class="p">])</span>
    <span class="n">flask_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;flask&#39;</span><span class="p">])</span>


    <span class="c"># Create an instance of Flask, so we can add it to the Tornado routing table, below.</span>
    <span class="n">flask_app</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flask_settings</span><span class="p">)</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s">&#39;/upload&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">UploadHandler</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="s">&#39;UploadHandler&#39;</span><span class="p">))</span>
    <span class="n">flask_wsgi</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIContainer</span><span class="p">(</span><span class="n">flask_app</span><span class="p">)</span>

    <span class="c"># Parse -v, -vvv, etc for verbosity, starting with the level in settings.</span>
    <span class="c"># Parse -v for INFO, -vv for DEBUG, etc</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">loglevel</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loglevel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">loglevel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">server</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="c"># Debug</span>
        <span class="k">if</span> <span class="n">loglevel</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">tornado_settings</span><span class="p">[</span><span class="s">&#39;compiled_template_cache&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">tornado_settings</span><span class="p">[</span><span class="s">&#39;autoreload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">tornado_settings</span><span class="p">[</span><span class="s">&#39;serve_traceback=True&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">flask_settings</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">r&quot;/&quot;</span><span class="p">,</span> <span class="n">EntryHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/__xsrf&quot;</span><span class="p">,</span> <span class="n">XSRFHandler</span><span class="p">),</span>

            <span class="p">(</span><span class="s">r&quot;/t/(.*)/(.*)/(.*)/history&quot;</span><span class="p">,</span> <span class="n">MessageHistoryHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/t/(.*)/(.*)/(.*)&quot;</span><span class="p">,</span> <span class="n">MessageHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/t/(.*)/settings&quot;</span><span class="p">,</span> <span class="n">TopicPropertiesHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/t/(.*)/new&quot;</span><span class="p">,</span> <span class="n">NewMessageHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/t/(.*)&quot;</span><span class="p">,</span> <span class="n">TopicHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/new&quot;</span><span class="p">,</span> <span class="n">NewMessageHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/new/attachment&quot;</span><span class="p">,</span> <span class="n">FileOnlyUploadHandler</span><span class="p">),</span>


         <span class="c">#   (r&quot;/new/(.*)&quot;, ReceiveEnvelopeHandler),</span>
         <span class="c">#   (r&quot;/new/file/(.*)&quot;, ReceiveEnvelopeHandler),</span>

            <span class="p">(</span><span class="s">r&quot;/all/saved&quot;</span><span class="p">,</span> <span class="n">AllSavedHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/all&quot;</span><span class="p">,</span> <span class="n">AllMessagesHandler</span><span class="p">),</span>

            <span class="p">(</span><span class="s">r&quot;/siteindex&quot;</span><span class="p">,</span> <span class="n">SiteIndexHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/sitemap/m/(\d+)&quot;</span><span class="p">,</span> <span class="n">SitemapMessagesHandler</span><span class="p">),</span>

            <span class="p">(</span><span class="s">r&quot;/s/(.*)&quot;</span><span class="p">,</span> <span class="n">SiteContentHandler</span><span class="p">),</span>


            <span class="p">(</span><span class="s">r&quot;/showtopics/(.*)&quot;</span><span class="p">,</span> <span class="n">ShowAllTopicsHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/showtopics&quot;</span><span class="p">,</span> <span class="n">ShowAllTopicsHandler</span><span class="p">),</span>
            <span class="c"># (r&quot;/showprivates&quot;, ShowPrivatesHandler),</span>
            <span class="c"># (r&quot;/privatem/(.*)&quot;, ShowPrivatesHandler),</span>

            <span class="c"># (r&quot;/attachment/(.*)&quot;, AttachmentHandler),</span>
            <span class="p">(</span><span class="s">r&quot;/u/(.*)&quot;</span><span class="p">,</span> <span class="n">UserHandler</span><span class="p">),</span>
            <span class="c"># (r&quot;/edit/(.*)&quot;, EditMessageHandler),</span>
            <span class="c"># (r&quot;/reply/(.*)/(.*)&quot;, ReplyHandler),</span>
            <span class="c"># (r&quot;/reply/(.*)&quot;, ReplyHandler),</span>
            <span class="c"># (r&quot;/pm/(.*)&quot;, NewPrivateMessageHandler),</span>
            <span class="p">(</span><span class="s">r&quot;/register&quot;</span><span class="p">,</span> <span class="n">RegisterHandler</span><span class="p">),</span>
            <span class="c"># (r&quot;/login/(.*)&quot;, LoginHandler),</span>
            <span class="c"># (r&quot;/login&quot;, LoginHandler),</span>
            <span class="c"># (r&quot;/changepassword&quot;, ChangepasswordHandler),</span>
            <span class="c"># (r&quot;/logout&quot;, LogoutHandler),</span>


            <span class="c"># (r&quot;/vote&quot;, RatingHandler),</span>
            <span class="c"># (r&quot;/usertrust&quot;, UserTrustHandler),</span>
            <span class="c"># (r&quot;/usernote&quot;, UserNoteHandler),</span>

            <span class="c"># (r&quot;/changesetting/(.*)/(.*)&quot;, ChangeSingleSettingHandler),</span>
            <span class="c"># (r&quot;/changesetting/(.*)&quot;, ChangeSingleSettingHandler),</span>
            <span class="c"># (r&quot;/changesettings&quot;, ChangeManySettingsHandler),</span>

            <span class="c"># (r&quot;/rss/(.*)/(.*)&quot;, RSSHandler),</span>

            <span class="p">(</span><span class="s">r&quot;/avatar/(.*)&quot;</span><span class="p">,</span> <span class="n">AvatarHandler</span><span class="p">),</span>
            <span class="c"># (r&quot;/binaries/(.*)/(.*)&quot;, BinariesHandler),</span>
            <span class="c"># (r&quot;/binaries/(.*)&quot;, BinariesHandler)</span>
            <span class="p">(</span><span class="s">r&quot;/upload&quot;</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">FallbackHandler</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="n">flask_wsgi</span><span class="p">)),</span>
            <span class="p">(</span><span class="s">r&quot;.*&quot;</span><span class="p">,</span> <span class="n">CatchallHandler</span><span class="p">),</span>
            <span class="p">]</span>

    <span class="c"># We want to create two application handlers inside webtav.</span>
    <span class="c"># One for Tornado, and one for Flask. This allows us to send requests to either.</span>

    <span class="n">tornado_app</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="n">handlers</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span><span class="o">**</span><span class="n">tornado_settings</span><span class="p">)</span>
    <span class="n">flask_app</span><span class="o">.</span><span class="n">tornado</span> <span class="o">=</span> <span class="n">tornado_app</span>

    <span class="c"># socket timeout 10s</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">http_server</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">tornado_app</span><span class="p">)</span>
    <span class="n">unix_socket</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">netutil</span><span class="o">.</span><span class="n">bind_unix_socket</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
    <span class="n">http_server</span><span class="o">.</span><span class="n">add_socket</span><span class="p">(</span><span class="n">unix_socket</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Started a webtav worker using socket on port &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">socket</span><span class="p">))</span>
    <span class="n">server</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Tavern is ready. Connect to Tavern on port &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">serversettings</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;webtav&#39;</span><span class="p">][</span><span class="s">&#39;port&#39;</span><span class="p">])</span><span class="o">+</span>  <span class="s">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Tavern  documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    </div>
  </body>
</html>