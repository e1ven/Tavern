{# Get the messages for the middle column #}

<table cellpadding="0" cellspacing="0" valign="top" role="presentation" width="100%">
    <tr height="10px">
        <td colspan=2>
            <hr id="column2HR">
        </td>
    </tr>
    <tr>
        <td>
            <h4><a id="column2Topic" href="{{url_for(topic=handler.topic)}}">{{handler.topic.name}}</a>
            </h4>
        </td>
        <td>
            <h4 id="column2MsgCount">{{ handler.topic.count(include_replies=False)}} Messages</h4>
        </td>
    </tr>
    <tr>
        <td colspan=2>
            {% if not handler.specialtopic %}
                {% if handler.user.follows_topic(handler.topic.sortname) %}
                    <form id='followtopic' class="followtopic" action="/changesetting/unfollowtopic" method="post"> <input type="hidden" value="{{handler.topic.sortname}}" name="topic">   {% module xsrf_form_html() %} <input type="submit" value='[This is a saved topic.]' class="textbutton topicpref"></form>
                {% else %}
                    <form id='followtopic' class="followtopic" action="/changesetting/followtopic" method="post"> <input type="hidden" value="{{handler.topic.sortname}}" name="topic">   {% module xsrf_form_html() %} <input type="submit" value='[Save this topic]' class="textbutton topicpref"></form>
                {% end %}
            {% end if %}
    </td>
    </tr>
    {% if not handler.specialtopic %}
    <tr>
        <td>
            <a href="{{url_for(topic=handler.topic)}}/settings">
               <button id="column2ButtonLeft" class="column2Buttons" type="button">
                Topic Setting
                <span class="icon-wrench-circled navIcon"></span>
               </button>
            </a>
        </td>
        <td>
          <a href="{{url_for(topic=handler.topic)}}/new" class="internal">
               <button id="column2ButtonRight" class="column2Buttons" type="button">
                New Message
                <span class="icon-pencil-circled navIcon"></span>
               </button>
            </a>
            </td>
    </tr>
    {% end if %}
</table>


<table cellpadding="0" cellspacing="0" valign="top" role="presentation" width="100%">
    <tr>
    <td valign="top">
        <ul class="messages">
        {% for subject in handler.messages %}
            {% set domclass = " " %}
            {% if handler.displayenvelope is not None %}
                {% if subject.dict['envelope']['local']['payload_sha512'] == handler.displayenvelope.dict['envelope']['local']['payload_sha512'] %}
                    {% set domclass = "active" %}
                {% end if %}
            {% end %}
            <li class="message  {{ domclass }}">
                <abbr title="{{subject.dict['envelope']['payload']['subject']}}">
                <a class='internal messagelink' href="{{url_for(envelope=subject)}}">
                  <h2><bdi>{{subject.dict['envelope']['payload']['subject']}}</bdi></h2>
                  <span class="bodypreview">{{subject.dict['envelope']['local']['short_body']}}</span>
                </a>
                {% if subject.countChildren() > 0 %}
                    <div class="replies"><div>{{subject.countChildren()}}</div></div>
                {% end %}
                </abbr>
            </li>
        {% end %}
        </ul>


        <table cellpadding="0" cellspacing="0" valign="top" role="presentation" width="100%">
            <tr>
                 <td>
                    {% if show_older %}
                    <a href="{{url_for(topic=handler.topic)}}?before={{handler.messages[0].dict['envelope']['local']['time_added']}}" class="internal">
                       <button id="older_messages" class="column2Buttons" type="button">
                        Older Messages
                        <span class="icon-left-circled navIcon"></span>
                       </button>
                    </a>
                    {% end %}
                </td>
                <td>
                    {% if show_newer %}
                    <a href="{{url_for(topic=handler.topic)}}?after={{handler.messages[-1].dict['envelope']['local']['time_added']}}">
                       <button id="newer_messages" class="column2Buttons" type="button">
                        Newer Messages
                        <span class="icon-right-circled navIcon"></span>
                       </button>
                    </a>
                    {% end %}
                </td>
            </tr>
        </table>


        </td>
    </tr>
</table>
