{% if 'attachmentlist' in envelope.dict['envelope']['local'] %}
    <div class="attachments">
        {% if envelope.dict['envelope']['local']['attachmentlist'] | length > 1%}
            Attached Files:<br>
        {% elif envelope.dict['envelope']['local']['attachmentlist'] | length > 0 %}
            Attached File: <br>
        {% endif %}
        {% for attachment in envelope.dict['envelope']['local']['attachmentlist'] %}
            {% if 'detected_mime' in attachment %}
                {% if attachment['detected_mime'] in ['video/mp4','video/webm'] %}
                    <video id="my_video_1" class="video-js vjs-default-skin" controls
                    preload="metadata" width="640" height="264"
                    data-setup="{}">
                        <source src="{{handler.server.serversettings.settings['downloadsurl']}}{{attachment['sha_512']}}/{{attachment['filename']}}" type='{{attachment['detected_mime']}}'>
                    </video>
                {% endif %}
                {% if attachment['detected_mime'] in ['audio/mpeg'] %}
                    <audio preload="metadata">
                      <source src="{{handler.server.serversettings.settings['downloadsurl']}}{{attachment['sha_512']}}/{{attachment['filename']}}">
                    </audio>
                {% endif %}

            {% endif %}

            {% if 'displayable' in attachment %}
                {% if attachment['displayable'] %}
                    <a href="{{handler.server.serversettings.settings['downloadsurl']}}{{attachment['sha_512']}}/{{attachment['filename']}}">
                        <img src="{{handler.server.serversettings.settings['downloadsurl']}}{{attachment['displayable']}}" alt="Thumbnail of enclosed image">
                        <br>
                    </a>
                {% endif %}
            {% endif %}


            <a href="{{handler.server.serversettings.settings['downloadsurl']}}{{attachment['sha_512']}}/{{attachment['filename']}}" download="{{attachment['filename']}}"><bdi>{{attachment['filename']}}</bdi></a> ({{ (attachment['filesize'] / 1024 / 1024)| round(precision=2) }} MB)
            <a href="/attachment/{{attachment['sha_512']}}"> <i class='icon-info-circled'></i></a>
            <br>
        {% endfor %}
    </div>
{% endif %}

{% if envelope.dict['envelope']['local']['embed'] | length > 0 %}
    {% if handler.user.UserSettings['allowembed'] == 1 %}
        <div class='embedded'>
        Linked Content:<Br>
            {% for embed in envelope.dict['envelope']['local']['embed'] %}
                {{ embed }}
            {% endfor %}
        </div>
    {% elif handler.user.UserSettings['allowembed'] == 0 %}
        <i class="icon-picture embeddedcontentnote"></i>
        <div id="embededcontent_{{envelope.dict['envelope']['local']['payload_sha512']}}" class="embededwarning" stufftoshow="Linked Content:<br>
            {% for embed in envelope.dict['envelope']['local']['embed'] %}
                {{ embed }}
            {% endfor %}
            ">
            <br>
            This message contains a link to a picture or movie hosted by some other service.<Br>
            Tavern can automatically display a lot of linked content, but (like any webpage) the site it's loaded from will know you viewed it.<br>
            <br>
            <form action="/changesetting/showembeds" method="post" class='alwaysdisplay'> 
                {# raw xsrf_form_html() #}
                <input type="submit" value='Always display external content' class="textbutton"> <br>
            </form>
            <br>
            <p>You can always change this setting in <a href="/user/{{handler.user.Keys['master'].pubkey}}">your user preferences</a></p>
        </div>
    {% elif handler.user.UserSettings['allowembed'] == -1 %}
        {# Pass. This is intentionally blank for users who have opted out of embeds #}

    {% endif %}
{% endif %}