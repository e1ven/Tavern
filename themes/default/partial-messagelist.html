<!-- Get the messages for the middle column -->
% from TopicTool import topictool

% if requestvars['topic'] != 'all-subscribed':
    % subjects = topictool.messages(before=requestvars['before'],topic=requestvars['topic'],maxposts=requestvars['user'].UserSettings['maxposts'])
% else:
    % subjects = topictool.messages(before=requestvars['before'],topic=requestvars['user'].UserSettings['followedTopics'],maxposts=requestvars['user'].UserSettings['maxposts'])
% end

% if len(subjects) > 0:
    % beforecount = topictool.topicCount(before=subjects[0].dict['envelope']['local']['time_added'],topic=requestvars['topic'])
    % aftercount = topictool.topicCount(after=subjects[0].dict['envelope']['local']['time_added'],topic=requestvars['topic'])
    % newbefore = topictool.getbackdate(after=subjects[0].dict['envelope']['local']['time_added'],topic=requestvars['topic'],maxposts=requestvars['user'].UserSettings['maxposts']) 
% else:
    % beforecount = 0
    % aftercount = 0
% end

<table cellpadding="0" cellspacing="0" valign="top" role="presentation" width="100%">
	<tr height="10px">
		<td colspan=2>
			<hr id="column2HR">
		</td>
	</tr>
	<tr>
    	<td>
        	<h4><a id="column2Topic" href="/topic/{{requestvars['server'].sorttopic(requestvars['topic'])}}">{{requestvars['topic']}}</a>
            </h4>
        </td>
        <td>
    		<h4 id="column2MsgCount">{{topictool.topicCount(topic=requestvars['topic'],toponly=False)}} Messages</h4>
    	</td>
    </tr>
    <tr>
        <td colspan=2>
            % sortedtopic =  [ requestvars['server'].sorttopic(x) for x in requestvars['user'].UserSettings['followedTopics'] ]
            % if requestvars['server'].sorttopic(requestvars['topic']) in sortedtopic:
                <form id='followtopic' class="followtopic" action="/changesetting/unfollowtopic" method="post"> <input type="hidden" value="{{topic}}" name="topic">   {% raw xsrf_form_html() %} <input type="submit" value='[This is a saved topic.]' class="textbutton topicpref"></form>
                % else:
                <form id='followtopic' class="followtopic" action="/changesetting/followtopic" method="post"> <input type="hidden" value="{{requestvars['topic']}}" name="topic">   {% raw xsrf_form_html() %} <input type="submit" value='[Save this topic]' class="textbutton topicpref"></form>
            % end
    </td>
    </tr>
    <tr>
    	<td>    
            <a href="/topicinfo/{{requestvars['server'].sorttopic(requestvars['topic'])}}">
    		   <button id="column2ButtonLeft" class="column2Buttons" type="button">
                Topic Setting
    			<span class="icon-wrench-circled navIcon"></span>
    		   </button>
            </a>
    	</td>
    	<td>
          <a href="/newmessage/{{requestvars['server'].sorttopic(requestvars['topic'])}}" class="internal">
               <button id="column2ButtonRight" class="column2Buttons" type="button">
                New Message
                <span class="icon-pencil-circled navIcon"></span>
               </button>
            </a>
			</td>
    </tr>
</table>


	<table cellpadding="0" cellspacing="0" valign="top" role="presentation" width="100%">
		<tr>
		<td valign="top">
            <ul class="messages">
            % for subject in subjects:
                <li class="message {%if subject.dict['envelope']['local']['payload_sha512'] == envelope.dict['envelope']['local']['payload_sha512']%} active{% end %}">
                    <abbr title="{{subject.dict['envelope']['payload']['subject']}}">
                    <a class='internal messagelink' href="/message/{{requestvars['server'].sorttopic(requestvars['topic'])}}/{{subject.dict['envelope']['local']['short_subject']}}/{{subject.dict['envelope']['local']['payload_sha512']}}">
                      <h2><bdi>{{subject.dict['envelope']['payload']['subject']}}</bdi></h2>
                      <span class="bodypreview">{{subject.dict['envelope']['local']['short_body']}}</span> 
                    </a>
                    % if subject.countChildren() > 0:
                        <div class="replies"><div>{{subject.countChildren()}}</div></div> 
                    % end
                    </abbr>
                </li>
            % end
            </ul>

          
            <table cellpadding="0" cellspacing="0" valign="top" role="presentation" width="100%">
                <tr>
                    <td>   
                        % if aftercount > 0:
                        <a href="/topic/{{topic}}?before={{newbefore}}">
                           <button id="NewerMessages" class="column2Buttons" type="button">
                            Newer Messages
                            <span class="icon-right-circled navIcon"></span>
                           </button>
                        </a>
                        % end
                    </td>
                    <td>
                        % if beforecount > 0:
                        <a href="/topic/{{requestvars['topic']}}?before={{subjects[-1].dict['envelope']['local']['time_added']}}" class="internal">
                           <button id="OlderMessages" class="column2Buttons" type="button">
                            Older Messages
                            <span class="icon-left-circled navIcon"></span>
                           </button>
                        </a>
                        % end
                    </td>
                </tr>
            </table>


		</td>
    </tr>
</table>